{% extends "base.html" %}

{% block title %}NvMé˜Ÿåˆ— - Jobè°ƒåº¦æŒ‡æŒ¥å®˜{% endblock %}

{% block content %}
<div class="page-shell container-fluid h-100 d-flex flex-column">
    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <div class="mb-3">
        <h2 class="mb-2">ğŸš¦ Jobè°ƒåº¦æŒ‡æŒ¥å®˜: ç´§æ€¥ä»»åŠ¡å¤§è€ƒéªŒï¼</h2>
        <div class="alert alert-info mb-0">
            <strong>ğŸ¯ ä»»åŠ¡ç›®æ ‡:</strong> ä½œä¸ºNvMè°ƒåº¦å‘˜ï¼Œä½ éœ€è¦ç®¡ç†Jobé˜Ÿåˆ—ï¼Œå¤„ç†ä¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼<br>
            <small>æŒ‘æˆ˜ï¼šåœ¨ç´§æ€¥ä»»åŠ¡ï¼ˆIMMEDIATEï¼‰ä¸æ–­æ’å…¥æ—¶ï¼Œä¿æŒç³»ç»Ÿé«˜æ•ˆè¿è¡Œï¼Œé¿å…é˜Ÿåˆ—å µå¡ï¼</small>
        </div>
    </div>

    <!-- å·¦å³å¸ƒå±€: å·¦ä¾§å¯è§†åŒ–ï¼Œå³ä¾§æ“ä½œ -->
    <div class="row flex-grow-1 g-3">
        <!-- å·¦ä¾§: å¯è§†åŒ–åŒºåŸŸ (58%) -->
        <div class="col-lg-7">
            <div class="d-flex flex-column gap-3 h-100">
                <!-- Jobé˜Ÿåˆ— -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <h5 class="mb-0">ğŸ“‹ Jobé˜Ÿåˆ— (æ¨ªå‘è§†å›¾)</h5>
                        <div>
                            <span class="badge bg-primary me-2">é˜Ÿåˆ—é•¿åº¦: <span id="queueLength">0</span></span>
                            <span class="badge bg-warning">ç­‰å¾…ä¸­: <span id="waitingCount">0</span></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="horizontalQueue" class="horizontal-queue" style="min-height: 100px;">
                            <!-- Jobå¡ç‰‡æ¨ªå‘æ’åˆ— -->
                            <div class="queue-empty">é˜Ÿåˆ—ä¸ºç©º</div>
                        </div>
                    </div>
                </div>

                <!-- å½“å‰æ‰§è¡Œ + çŠ¶æ€æœº -->
                <div class="row">
                    <div class="col-md-6">
                        <!-- å½“å‰æ‰§è¡Œçš„Job -->
                        <div class="card h-100">
                            <div class="card-header bg-success">
                                <h5 class="mb-0">ğŸ¯ æ­£åœ¨æ‰§è¡Œ</h5>
                            </div>
                            <div class="card-body" id="currentJob">
                                <div class="text-center text-muted">
                                    <p>æ— Jobæ‰§è¡Œä¸­</p>
                                    <small>NvMç©ºé—²</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <!-- çŠ¶æ€æœºå¯è§†åŒ– -->
                        <div class="card h-100">
                            <div class="card-header">
                                <h5 class="mb-0">ğŸ”„ çŠ¶æ€æœºæ—…ç¨‹</h5>
                            </div>
                            <div class="card-body">
                                <div class="state-machine-viz">
                                    <div class="state-node" id="state-idle">
                            <div class="state-circle bg-secondary">IDLE</div>
                        </div>
                        <div class="state-arrow">â†’</div>
                        <div class="state-node" id="state-reading">
                            <div class="state-circle bg-primary">READING</div>
                        </div>
                        <div class="state-arrow">â†’</div>
                        <div class="state-node" id="state-verifying">
                            <div class="state-circle bg-info">VERIFYING</div>
                        </div>
                        <div class="state-arrow">â†’</div>
                        <div class="state-node" id="state-completing">
                            <div class="state-circle bg-success">COMPLETING</div>
                        </div>
                    </div>
                    <div class="mt-3 text-center">
                        <small class="text-muted">å½“å‰çŠ¶æ€: <strong id="currentStateText">IDLE</strong></small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <!-- æ·»åŠ æ–°Job -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">â• æ‰‹åŠ¨æ·»åŠ Job</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label">Jobç±»å‹:</label>
                            <select id="jobTypeSelect" class="form-select form-select-sm">
                                <option value="READ">ğŸ“– ReadBlock</option>
                                <option value="WRITE">âœï¸ WriteBlock</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Block ID:</label>
                            <select id="blockIdSelect" class="form-select form-select-sm">
                                <option value="0">Block 0</option>
                                <option value="1">Block 1</option>
                                <option value="2">Block 2</option>
                                <option value="3">Block 3</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label">ä¼˜å…ˆçº§:</label>
                            <select id="prioritySelect" class="form-select form-select-sm">
                                <option value="LOW">ğŸŸ¢ LOW</option>
                                <option value="MED">ğŸŸ¡ MED</option>
                                <option value="HIGH">ğŸ”´ HIGH</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">
                                <input type="checkbox" id="immediateCheck"> âš¡ Immediateæ’é˜Ÿ
                            </label>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100" onclick="manualEnqueue()">
                        ğŸ“¤ æ‰‹åŠ¨å…¥é˜Ÿ
                    </button>
                    <hr>
                    <div class="alert alert-warning small">
                        <strong>æç¤º:</strong>
                        <ul class="mb-0">
                            <li>âš¡ Immediateä»»åŠ¡ä¼šæ’é˜Ÿåˆ°é˜Ÿåˆ—æœ€å‰é¢</li>
                            <li>ğŸ”´ HIGHä¼˜å…ˆçº§åœ¨æ™®é€šä»»åŠ¡ä¸­ä¼˜å…ˆæ‰§è¡Œ</li>
                            <li>ğŸ“º è§‚å¯ŸçŠ¶æ€æœºçš„å®æ—¶å˜åŒ–</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ€§èƒ½æŒ‡æ ‡ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary" id="completedJobs">0</h3>
                    <p class="mb-0">å·²å®ŒæˆJob</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success" id="avgExecTime">0</h3>
                    <p class="mb-0">å¹³å‡è€—æ—¶(ms)</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-warning" id="retryCount">0</h3>
                    <p class="mb-0">é‡è¯•æ¬¡æ•°</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-danger" id="maxQueueLen">0</h3>
                    <p class="mb-0">æœ€å¤§é˜Ÿåˆ—é•¿åº¦</p>
                </div>
            </div>
        </div>
    </div>

        <!-- å³ä¾§: æ“ä½œé¢æ¿ (42%) -->
        <div class="col-lg-5">
            <div class="d-flex flex-column gap-3 h-100">
                <!-- æŒ‘æˆ˜æ¨¡å¼ -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">ğŸ® æŒ‘æˆ˜æ¨¡å¼</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2 mb-3">
                            <button class="btn btn-success" onclick="startChallenge('normal')">
                                ğŸŒ¿ æ­£å¸¸æ¨¡å¼
                            </button>
                            <button class="btn btn-warning" onclick="startChallenge('emergency')">
                                âš¡ ç´§æ€¥æ¨¡å¼
                            </button>
                            <button class="btn btn-danger" onclick="startChallenge('congestion')">
                                ğŸŒªï¸ å µå¡æ¨¡å¼
                            </button>
                        </div>

                        <div class="row">
                            <div class="col-6">
                                <label class="form-label small">åŠ¨ç”»é€Ÿåº¦:</label>
                                <select id="speedSelect" class="form-select form-select-sm">
                                    <option value="500">æ…¢é€Ÿ</option>
                                    <option value="200" selected>æ­£å¸¸</option>
                                    <option value="50">å¿«é€Ÿ</option>
                                    <option value="0">ç¬é—´</option>
                                </select>
                            </div>
                            <div class="col-6 text-end">
                                <button class="btn btn-secondary btn-sm w-100" onclick="resetSim()">
                                    ğŸ”„ é‡ç½®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ‰‹åŠ¨æ·»åŠ Job -->
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">â• æ‰‹åŠ¨æ·»åŠ Job</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label class="form-label small">ä¼˜å…ˆçº§:</label>
                            <select id="jobPriority" class="form-select form-select-sm">
                                <option value="LOW">LOW (ä½)</option>
                                <option value="MEDIUM">MEDIUM (ä¸­)</option>
                                <option value="HIGH">HIGH (é«˜)</option>
                                <option value="IMMEDIATE">IMMEDIATE (ç´§æ€¥)</option>
                            </select>
                        </div>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-sm" onclick="addManualJob()">
                                ğŸ“ æ·»åŠ å•ä¸ªJob
                            </button>
                            <button class="btn btn-success btn-sm" onclick="startAutoQueue()" id="autoQueueBtn">
                                ğŸ¤– è‡ªåŠ¨ç”ŸæˆJob
                            </button>
                        </div>
                    </div>
                </div>

                <!-- äº‹ä»¶æ—¥å¿— -->
                <div class="card flex-grow-1">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">ğŸ“‹ è°ƒåº¦äº‹ä»¶æ—¥å¿—</h5>
                    </div>
                    <div class="card-body" style="max-height: 250px; overflow-y: auto; font-size: 12px;">
                        <div id="eventLog">
                            <p class="text-muted text-center">ç­‰å¾…Jobå…¥é˜Ÿ...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æˆåŠŸåº†ç¥æ¨¡æ€æ¡† -->
    <div class="modal" id="challengeCompleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">ğŸ‰ æŒ‘æˆ˜å®Œæˆï¼</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>âœ… ä½ æˆåŠŸå®Œæˆäº†æŒ‘æˆ˜ï¼</h6>
                    <div id="challengeSummary"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        ç»§ç»­æ¢ç´¢
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ç¡®ä¿ä¸»è¦å†…å®¹åŒºåŸŸå……æ»¡å¯ç”¨ç©ºé—´ï¼Œä½†ä¸å½±å“å¯¼èˆªæ å®¹å™¨ */
.page-shell {
    min-height: calc(100vh - 100px);
}

.horizontal-queue {
    display: flex;
    gap: 6px;
    overflow-x: auto;
    padding: 10px;
    min-height: 100px;
    align-items: center;
    max-width: 100%;
}

.queue-empty {
    width: 100%;
    text-align: center;
    color: #6c757d;
    font-style: italic;
    font-size: 0.9em;
}

.job-card {
    min-width: 120px;
    max-width: 120px;
    padding: 8px;
    border-radius: 4px;
    animation: job-enter 0.5s ease-out;
    position: relative;
    transition: all 0.3s;
    font-size: 0.9em;
}

.job-card:hover {
    transform: scale(1.05);
    z-index: 10;
}

.job-card.immediate {
    border: 3px solid #dc3545;
    animation: job-drop-in 0.6s ease-out, immediate-pulse 1s infinite;
}

.job-card.high-priority {
    border: 2px solid #dc3545;
}

.job-card.med-priority {
    border: 2px solid #ffc107;
}

.job-card.low-priority {
    border: 2px solid #28a745;
}

@keyframes job-enter {
    from {
        opacity: 0;
        transform: translateX(-100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes job-drop-in {
    0% {
        opacity: 0;
        transform: translateY(-100px) scale(0.5);
    }
    60% {
        transform: translateY(10px) scale(1.1);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes immediate-pulse {
    0%, 100% {
        box-shadow: 0 0 5px rgba(220, 53, 69, 0.5);
    }
    50% {
        box-shadow: 0 0 20px rgba(220, 53, 69, 0.8);
    }
}

.state-machine-viz {
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 20px;
}

.state-node {
    text-align: center;
}

.state-circle {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    font-size: 12px;
    transition: all 0.3s;
    border: 3px solid transparent;
}

.state-circle.active {
    transform: scale(1.2);
    box-shadow: 0 0 20px rgba(0, 123, 255, 0.6);
    border-color: #007bff;
}

.state-arrow {
    font-size: 24px;
    color: #6c757d;
    font-weight: bold;
}

.log-entry {
    padding: 8px 10px;
    margin-bottom: 5px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    border-left: 4px solid #007bff;
}

.log-enqueue { background: #d1ecf1; border-left-color: #17a2b8; }
.log-execute { background: #d4edda; border-left-color: #28a745; }
.log-immediate { background: #f8d7da; border-left-color: #dc3545; }
.log-complete { background: #cce5ff; border-left-color: #004085; }

/* å“åº”å¼ */
@media (max-width: 991px) {
    .page-shell {
        min-height: auto;
    }

    .horizontal-queue {
        min-height: 80px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let jobQueue = [];
let currentJob = null;
let currentState = 'IDLE';
let completedJobs = 0;
let retryCount = 0;
let maxQueueLen = 0;
let autoQueueInterval = null;
let currentChallenge = null;
let jobCounter = 0;

// åˆå§‹åŒ–
function init() {
    updateDisplay();
    addLog('ğŸš€ NvMè°ƒåº¦ç³»ç»Ÿå·²å¯åŠ¨', 'info');
}

// å¼€å§‹æŒ‘æˆ˜
function startChallenge(mode) {
    currentChallenge = mode;
    resetSim();

    let challengeName = {
        'normal': 'ğŸŒ¿ æ­£å¸¸æ¨¡å¼',
        'emergency': 'âš¡ ç´§æ€¥æ¨¡å¼',
        'congestion': 'ğŸŒªï¸ å µå¡æ¨¡å¼'
    }[mode];

    addLog(`ğŸ® å¼€å§‹æŒ‘æˆ˜: ${challengeName}`, 'info');

    // æ ¹æ®æ¨¡å¼è‡ªåŠ¨ç”ŸæˆJob
    if (mode === 'normal') {
        generateJobs(5, 0);
    } else if (mode === 'emergency') {
        generateJobs(3, 0);
        setTimeout(() => generateJobs(5, 3), 2000);
    } else if (mode === 'congestion') {
        generateJobs(10, 0);
        setTimeout(() => generateJobs(10, 5), 3000);
    }
}

// ç”ŸæˆJob
function generateJobs(count, immediateCount) {
    for (let i = 0; i < count; i++) {
        const isImmediate = i < immediateCount;
        const priority = ['LOW', 'MED', 'HIGH'][Math.floor(Math.random() * 3)];
        const type = ['READ', 'WRITE'][Math.floor(Math.random() * 2)];
        const blockId = Math.floor(Math.random() * 4);

        enqueueJobInternal(type, blockId, priority, isImmediate);
    }
}

// æ‰‹åŠ¨å…¥é˜Ÿ
function manualEnqueue() {
    const type = document.getElementById('jobTypeSelect').value;
    const blockId = parseInt(document.getElementById('blockIdSelect').value);
    const priority = document.getElementById('prioritySelect').value;
    const immediate = document.getElementById('immediateCheck').checked;

    enqueueJobInternal(type, blockId, priority, immediate);
}

// å†…éƒ¨å…¥é˜Ÿå‡½æ•°
async function enqueueJobInternal(type, blockId, priority, immediate) {
    jobCounter++;
    const job = {
        job_id: jobCounter,
        type: type,
        block_id: blockId,
        priority: priority,
        immediate: immediate,
        state: 'QUEUED',
        wait_time: 0,
        enqueue_time: Date.now()
    };

    // Immediateä»»åŠ¡æ’é˜Ÿåˆ°æœ€å‰é¢
    if (immediate) {
        jobQueue.unshift(job);
        addLog(`âš¡ Job #${job.job_id} æ’é˜Ÿå…¥é˜Ÿï¼`, 'immediate');
    } else {
        // æŒ‰ä¼˜å…ˆçº§æ’åºï¼ˆHIGHåœ¨å‰ï¼‰
        const priorityOrder = { 'HIGH': 0, 'MED': 1, 'LOW': 2 };
        const insertIdx = jobQueue.findIndex(j => priorityOrder[j.priority] > priorityOrder[priority]);
        if (insertIdx >= 0) {
            jobQueue.splice(insertIdx, 0, job);
        } else {
            jobQueue.push(job);
        }
        addLog(`ğŸ“¤ Job #${job.job_id} å…¥é˜Ÿ (${priority}ä¼˜å…ˆçº§)`, 'enqueue');
    }

    maxQueueLen = Math.max(maxQueueLen, jobQueue.length);
    updateDisplay();

    // å¦‚æœç©ºé—²ï¼Œç«‹å³æ‰§è¡Œ
    if (currentState === 'IDLE' && !currentJob) {
        await executeNextJob();
    }
}

// æ‰§è¡Œä¸‹ä¸€ä¸ªJob
async function executeNextJob() {
    if (jobQueue.length === 0) {
        currentState = 'IDLE';
        updateDisplay();
        return;
    }

    const job = jobQueue.shift();
    currentJob = job;
    currentState = 'READING';
    updateDisplay();

    const speed = parseInt(document.getElementById('speedSelect').value);
    addLog(`ğŸ¯ å¼€å§‹æ‰§è¡Œ Job #${job.job_id} - ${job.type} Block${job.block_id}`, 'execute');

    // æ¨¡æ‹ŸçŠ¶æ€æœºè½¬æ¢
    await sleep(speed);
    currentState = 'VERIFYING';
    updateDisplay();

    await sleep(speed);
    currentState = 'COMPLETING';
    updateDisplay();

    await sleep(speed);

    // å®Œæˆ
    completedJobs++;
    addLog(`âœ… Job #${job.job_id} å®Œæˆï¼`, 'complete');

    currentJob = null;

    // æ£€æŸ¥æ˜¯å¦å®ŒæˆæŒ‘æˆ˜
    if (jobQueue.length === 0 && currentChallenge) {
        showChallengeComplete();
    }

    // ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ª
    await executeNextJob();
}

// æ›´æ–°æ˜¾ç¤º
function updateDisplay() {
    // æ›´æ–°é˜Ÿåˆ—
    const queueDiv = document.getElementById('horizontalQueue');
    if (jobQueue.length === 0) {
        queueDiv.innerHTML = '<div class="queue-empty">é˜Ÿåˆ—ä¸ºç©º</div>';
    } else {
        queueDiv.innerHTML = jobQueue.map(job => {
            const priorityClass = {
                'HIGH': 'high-priority',
                'MED': 'med-priority',
                'LOW': 'low-priority'
            }[job.priority];

            const bgClass = job.immediate ? 'bg-danger' : 'bg-light';

            return `
                <div class="card job-card ${priorityClass} ${job.immediate ? 'immediate' : ''} ${bgClass}">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between">
                            <strong>#${job.job_id}</strong>
                            <span class="badge badge-sm bg-${job.priority === 'HIGH' ? 'danger' : job.priority === 'MED' ? 'warning' : 'success'}">
                                ${job.priority}
                            </span>
                        </div>
                        <div class="small mt-1">
                            ${job.type}<br>
                            Block ${job.block_id}
                        </div>
                        ${job.immediate ? '<div class="text-danger small mt-1">âš¡ IMMEDIATE</div>' : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    document.getElementById('queueLength').textContent = jobQueue.length;
    document.getElementById('waitingCount').textContent = jobQueue.filter(j => !j.immediate).length;

    // æ›´æ–°å½“å‰Job
    const currentJobDiv = document.getElementById('currentJob');
    if (currentJob) {
        const priorityColor = currentJob.priority === 'HIGH' ? 'danger' : currentJob.priority === 'MED' ? 'warning' : 'success';
        currentJobDiv.innerHTML = `
            <div class="card border-${priorityColor}">
                <div class="card-body">
                    <h5>Job #${currentJob.job_id} - ${currentJob.type}</h5>
                    <p><strong>Block:</strong> ${currentJob.block_id}</p>
                    <p><strong>ä¼˜å…ˆçº§:</strong> <span class="badge bg-${priorityColor}">${currentJob.priority}</span></p>
                    ${currentJob.immediate ? '<span class="badge bg-danger">âš¡ IMMEDIATE</span>' : ''}
                    <p class="mt-2"><strong>çŠ¶æ€:</strong> <span class="badge bg-primary">${currentState}</span></p>
                </div>
            </div>
        `;
    } else {
        currentJobDiv.innerHTML = `
            <div class="text-center text-muted">
                <p>æ— Jobæ‰§è¡Œä¸­</p>
                <small>NvMç©ºé—² - ${currentState}</small>
            </div>
        `;
    }

    // æ›´æ–°çŠ¶æ€æœº
    document.querySelectorAll('.state-circle').forEach(el => el.classList.remove('active'));
    const stateId = 'state-' + currentState.toLowerCase();
    const stateEl = document.getElementById(stateId);
    if (stateEl) {
        stateEl.querySelector('.state-circle').classList.add('active');
    }
    document.getElementById('currentStateText').textContent = currentState;

    // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
    document.getElementById('completedJobs').textContent = completedJobs;
    document.getElementById('avgExecTime').textContent = completedJobs > 0 ? (150 + Math.random() * 50).toFixed(0) : 0;
    document.getElementById('retryCount').textContent = retryCount;
    document.getElementById('maxQueueLen').textContent = maxQueueLen;
}

// æ·»åŠ æ—¥å¿—
function addLog(message, type = 'enqueue') {
    const log = document.getElementById('eventLog');
    const entry = document.createElement('div');
    entry.className = `log-entry log-${type}`;
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

    if (log.querySelector('.text-muted')) {
        log.innerHTML = '';
    }

    log.insertBefore(entry, log.firstChild);

    // é™åˆ¶æ—¥å¿—æ•°é‡
    while (log.children.length > 50) {
        log.removeChild(log.lastChild);
    }
}

// æ˜¾ç¤ºæŒ‘æˆ˜å®Œæˆ
function showChallengeComplete() {
    const modal = new bootstrap.Modal(document.getElementById('challengeCompleteModal'));

    const summary = {
        'normal': `
            <p>ä½ æˆåŠŸå®Œæˆäº†æ­£å¸¸æ¨¡å¼æŒ‘æˆ˜ï¼</p>
            <ul>
                <li>âœ… å®Œæˆ ${completedJobs} ä¸ªJob</li>
                <li>âœ… ç†è§£äº†FIFOé˜Ÿåˆ—æœºåˆ¶</li>
                <li>ğŸ“š çŸ¥è¯†ç‚¹: ä»»åŠ¡æŒ‰å…¥é˜Ÿé¡ºåºæ‰§è¡Œ</li>
            </ul>
        `,
        'emergency': `
            <p>ä½ æˆåŠŸåº”å¯¹äº†ç´§æ€¥ä»»åŠ¡æŒ‘æˆ˜ï¼</p>
            <ul>
                <li>âœ… å®Œæˆ ${completedJobs} ä¸ªJob (å«IMMEDIATEä»»åŠ¡)</li>
                <li>âœ… ç†è§£äº†æ’é˜Ÿæœºåˆ¶çš„å½±å“</li>
                <li>ğŸ“š çŸ¥è¯†ç‚¹: Immediateä»»åŠ¡æ‰“æ–­æ­£å¸¸é˜Ÿåˆ—</li>
            </ul>
        `,
        'congestion': `
            <p>ä½ å®Œæˆäº†æé™å‹åŠ›æµ‹è¯•ï¼</p>
            <ul>
                <li>âœ… å®Œæˆ ${completedJobs} ä¸ªJob</li>
                <li>âœ… æœ€å¤§é˜Ÿåˆ—é•¿åº¦: ${maxQueueLen}</li>
                <li>ğŸ“š çŸ¥è¯†ç‚¹: é˜Ÿåˆ—è¿‡é•¿ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™</li>
            </ul>
        `
    }[currentChallenge];

    document.getElementById('challengeSummary').innerHTML = summary;
    modal.show();

    currentChallenge = null;
}

// è‡ªåŠ¨ç”ŸæˆJob
function startAutoQueue() {
    if (autoQueueInterval) {
        clearInterval(autoQueueInterval);
        autoQueueInterval = null;
        document.getElementById('autoQueueBtn').textContent = 'ğŸ¤– è‡ªåŠ¨ç”ŸæˆJob';
        document.getElementById('autoQueueBtn').classList.remove('btn-danger');
        document.getElementById('autoQueueBtn').classList.add('btn-success');
    } else {
        autoQueueInterval = setInterval(() => {
            const isImmediate = Math.random() < 0.2;
            const priority = ['LOW', 'MED', 'HIGH'][Math.floor(Math.random() * 3)];
            const type = ['READ', 'WRITE'][Math.floor(Math.random() * 2)];
            const blockId = Math.floor(Math.random() * 4);
            enqueueJobInternal(type, blockId, priority, isImmediate);
        }, 1000);

        document.getElementById('autoQueueBtn').textContent = 'â¹ï¸ åœæ­¢ç”Ÿæˆ';
        document.getElementById('autoQueueBtn').classList.remove('btn-success');
        document.getElementById('autoQueueBtn').classList.add('btn-danger');
    }
}

// é‡ç½®
function resetSim() {
    if (autoQueueInterval) {
        clearInterval(autoQueueInterval);
        autoQueueInterval = null;
        document.getElementById('autoQueueBtn').textContent = 'ğŸ¤– è‡ªåŠ¨ç”ŸæˆJob';
        document.getElementById('autoQueueBtn').classList.remove('btn-danger');
        document.getElementById('autoQueueBtn').classList.add('btn-success');
    }

    jobQueue = [];
    currentJob = null;
    currentState = 'IDLE';
    completedJobs = 0;
    retryCount = 0;
    maxQueueLen = 0;
    jobCounter = 0;
    currentChallenge = null;

    document.getElementById('eventLog').innerHTML = '<p class="text-muted text-center">ç­‰å¾…Jobå…¥é˜Ÿ...</p>';

    updateDisplay();
    addLog('ğŸ”„ ç³»ç»Ÿå·²é‡ç½®', 'info');
}

// è¾…åŠ©å‡½æ•°
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// é¡µé¢åŠ è½½åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    init();
});
</script>
{% endblock %}
