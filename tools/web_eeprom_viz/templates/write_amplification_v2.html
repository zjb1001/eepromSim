{% extends "base.html" %}

{% block title %}å†™æ”¾å¤§å¯è§†åŒ– - EEPROMäº¤äº’å¼å­¦ä¹ {% endblock %}

{% block content %}
<div class="page-shell container-fluid h-100 d-flex flex-column">
    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <div class="mb-3">
        <h2 class="mb-2">ğŸ”¬ å®éªŒ: ä¸ºä»€ä¹ˆä¿®æ”¹1å­—èŠ‚è¦æ“¦é™¤256å­—èŠ‚ï¼Ÿ</h2>
        <div class="alert alert-warning mb-0">
            <strong>ğŸ¯ ä»»åŠ¡:</strong> å°è¯•ä¿®æ”¹Pageä¸­çº¢è‰²çš„ä¸€ä¸ªå­—èŠ‚ï¼Œè§‚å¯ŸEEPROMå®é™…åšäº†ä»€ä¹ˆæ“ä½œï¼
        </div>
    </div>

    <!-- å·¦å³å¸ƒå±€: å·¦ä¾§å¯è§†åŒ–ï¼Œå³ä¾§æ“ä½œ -->
    <div class="row flex-grow-1 g-3">
        <!-- å·¦ä¾§: å¯è§†åŒ–åŒºåŸŸ (58%) -->
        <div class="col-lg-7">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ“¦ EEPROM Page #0 å¯è§†åŒ– (256å­—èŠ‚)</h5>
                    <div>
                        <span class="badge bg-secondary me-2">æ“¦é™¤æ¬¡æ•°: <span id="eraseCount">0</span></span>
                        <span class="badge bg-info">å¯¿å‘½: <span id="lifePercent">100</span>%</span>
                    </div>
                </div>
                <div class="card-body d-flex flex-column">
                    <!-- Pageå­—èŠ‚ç½‘æ ¼ -->
                    <div id="pageGrid" class="eeprom-grid mb-3 flex-grow-1">
                        <!-- 16è¡Œ x 16åˆ— = 256å­—èŠ‚ -->
                    </div>

                    <!-- å›¾ä¾‹ -->
                    <div class="d-flex justify-content-center gap-4 flex-wrap">
                        <div class="d-flex align-items-center">
                            <div class="grid-cell-example" style="background: #e9ecef;"></div>
                            <small>æœªå†™å…¥ (0xFF)</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="grid-cell-example" style="background: #a8dadc;"></div>
                            <small>å·²å†™å…¥æ•°æ®</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="grid-cell-example" style="background: #ff6b6b;"></div>
                            <small>ç›®æ ‡ä½ç½®</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="grid-cell-example" style="background: #ffd93d;"></div>
                            <small>æ­£åœ¨æ“¦é™¤</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="grid-cell-example" style="background: #6bcf7f;"></div>
                            <small>æ­£åœ¨å†™å…¥</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§: æ“ä½œé¢æ¿ (42%) -->
        <div class="col-lg-5">
            <div class="d-flex flex-column gap-3 h-100">
                <!-- ä¿®æ”¹ç›®æ ‡å¡ç‰‡ -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">ğŸ¯ ä¿®æ”¹ç›®æ ‡è®¾ç½®</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">ç›®æ ‡ä½ç½® (å­—èŠ‚åç§»):</label>
                            <input type="range" id="offsetSlider" class="form-range" min="0" max="255" value="10">
                            <div class="text-center">
                                <span class="badge bg-primary" style="font-size: 1.2em;">åç§»: <span id="offsetDisplay">10</span></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æ–°æ•°æ® (1å­—èŠ‚):</label>
                            <select id="newDataSelect" class="form-select">
                                <option value="00">0x00 (å…¨0)</option>
                                <option value="AA">0xAA (10101010)</option>
                                <option value="55">0x55 (01010101)</option>
                                <option value="FF">0xFF (å…¨1)</option>
                            </select>
                        </div>

                        <div class="alert alert-secondary mb-0">
                            <div class="mb-2">
                                <strong>å½“å‰å€¼:</strong> <code id="currentValue">0xFF</code>
                            </div>
                            <div class="mb-2">
                                <strong>æ–°å€¼:</strong> <code id="newValue">0x00</code>
                            </div>
                            <div>
                                <strong>éœ€è¦æ“¦é™¤?</strong> <span id="needErase" class="badge bg-danger">æ˜¯ âŒ</span>
                            </div>
                        </div>

                        <button class="btn btn-primary w-100" id="writeBtn" onclick="attemptWrite()">
                            âœï¸ å°è¯•å†™å…¥
                        </button>
                    </div>
                </div>

                <!-- æ“ä½œæ—¥å¿—å¡ç‰‡ -->
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">ğŸ“‹ æ“ä½œæ—¥å¿—</h5>
                    </div>
                    <div class="card-body" style="max-height: 250px; overflow-y: auto;">
                        <div id="operationLog">
                            <p class="text-muted text-center">ç­‰å¾…æ“ä½œ...</p>
                        </div>
                    </div>
                </div>

                <!-- å†™æ”¾å¤§ç»Ÿè®¡å¡ç‰‡ -->
                <div class="card flex-grow-1">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">ğŸ“Š å†™æ”¾å¤§ç»Ÿè®¡</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center g-3">
                            <div class="col-6">
                                <div class="stat-box">
                                    <h3 class="text-primary mb-0" id="userIntent">1</h3>
                                    <small>ç”¨æˆ·å†™å…¥ (å­—èŠ‚)</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-box">
                                    <h3 class="text-warning mb-0" id="actualErase">0</h3>
                                    <small>æ“¦é™¤ (å­—èŠ‚)</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-box">
                                    <h3 class="text-success mb-0" id="actualWrite">0</h3>
                                    <small>å†™å…¥ (å­—èŠ‚)</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="stat-box">
                                    <h3 class="text-danger mb-0" id="amplification">0x</h3>
                                    <small>æ”¾å¤§å€æ•°</small>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="alert alert-info mb-0">
                            <h6 class="mb-2">ğŸ’¡ çŸ¥è¯†ç‚¹:</h6>
                            <p class="small mb-0">
                                EEPROMä¿®æ”¹1ä¸ªå­—èŠ‚ï¼Œå®é™…éœ€è¦æ“¦é™¤æ•´ä¸ªPageï¼ˆ256å­—èŠ‚ï¼‰ï¼Œ
                                è¿™å°±æ˜¯<strong>å†™æ”¾å¤§</strong>ç°è±¡ï¼
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ç¡®ä¿ä¸»è¦å†…å®¹åŒºåŸŸå……æ»¡å¯ç”¨ç©ºé—´ï¼Œä½†ä¸å½±å“å¯¼èˆªæ å®¹å™¨ */
.page-shell {
    min-height: calc(100vh - 100px);
}

/* EEPROMç½‘æ ¼ */
.eeprom-grid {
    display: grid;
    grid-template-columns: repeat(16, 1fr);
    gap: 0;
    background: #dee2e6;
    padding: 2px;
    border-radius: 2px;
    min-height: 220px;
    max-width: 100%;
    overflow: hidden;
}

.grid-cell {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 5px;
    font-family: monospace;
    background: #e9ecef;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: 14px;
}

.grid-cell:hover {
    transform: scale(1.1);
    z-index: 10;
}

.grid-cell.data-written {
    background: #a8dadc;
    font-weight: bold;
}

.grid-cell.target {
    background: #ff6b6b;
    font-weight: bold;
    animation: pulse 1s infinite;
}

.grid-cell.erasing {
    background: #ffd93d;
    animation: flash 0.3s;
}

.grid-cell.writing {
    background: #6bcf7f;
    animation: flash 0.3s;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); box-shadow: 0 0 15px rgba(255, 107, 107, 0.6); }
}

@keyframes flash {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* å›¾ä¾‹ */
.grid-cell-example {
    width: 20px;
    height: 20px;
    border-radius: 2px;
    margin-right: 5px;
}

/* æ“ä½œæ—¥å¿— */
.log-entry {
    padding: 8px;
    margin-bottom: 5px;
    border-radius: 4px;
    font-size: 12px;
    font-family: monospace;
    border-left: 3px solid #28a745;
}

.log-entry.info {
    background: #d1ecf1;
    border-left-color: #17a2b8;
}

.log-entry.erase {
    background: #fff3cd;
    border-left-color: #ffc107;
}

.log-entry.write {
    background: #d4edda;
    border-left-color: #28a745;
}

/* ç»Ÿè®¡æ¡† */
.stat-box {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
}

/* å“åº”å¼ */
@media (max-width: 991px) {
    .page-shell {
        min-height: auto;
    }

    .eeprom-grid {
        min-height: 300px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let pageData = new Array(256).fill(0xFF);
let eraseCount = 0;
let targetOffset = 10;
let isAnimating = false;

// åˆå§‹åŒ–Page
function initPage() {
    // é¢„å…ˆå†™å…¥ä¸€äº›æ•°æ®
    for (let i = 0; i < 50; i++) {
        pageData[i] = Math.floor(Math.random() * 256);
    }
    updateDisplay();
    updateAnalysis();
}

// æ›´æ–°æ˜¾ç¤º
function updateDisplay() {
    const grid = document.getElementById('pageGrid');
    grid.innerHTML = '';

    for (let i = 0; i < 256; i++) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.textContent = pageData[i].toString(16).toUpperCase().padStart(2, '0');

        // åº”ç”¨æ ·å¼
        if (pageData[i] !== 0xFF) {
            cell.classList.add('data-written');
        }

        if (i === targetOffset) {
            cell.classList.add('target');
        }

        cell.onclick = () => selectOffset(i);
        grid.appendChild(cell);
    }

    // æ›´æ–°ç»Ÿè®¡
    document.getElementById('eraseCount').textContent = eraseCount;
    document.getElementById('lifePercent').textContent = Math.max(0, 100 - eraseCount);
}

// æ›´æ–°åˆ†æ
function updateAnalysis() {
    const current = pageData[targetOffset];
    const newHex = document.getElementById('newDataSelect').value;
    const newValue = parseInt(newHex, 16);

    document.getElementById('currentValue').textContent = '0x' + current.toString(16).toUpperCase().padStart(2, '0');
    document.getElementById('newValue').textContent = '0x' + newValue.toString(16).toUpperCase().padStart(2, '0');

    const needErase = (current & newValue) !== current;
    const eraseSpan = document.getElementById('needErase');

    if (needErase) {
        eraseSpan.className = 'badge bg-danger';
        eraseSpan.textContent = 'æ˜¯ âŒ';
    } else {
        eraseSpan.className = 'badge bg-success';
        eraseSpan.textContent = 'å¦ âœ…';
    }
}

// é€‰æ‹©åç§»
function selectOffset(offset) {
    targetOffset = offset;
    document.getElementById('offsetSlider').value = offset;
    document.getElementById('offsetDisplay').textContent = offset;
    updateDisplay();
    updateAnalysis();
}

// å°è¯•å†™å…¥
async function attemptWrite() {
    if (isAnimating) return;

    const newHex = document.getElementById('newDataSelect').value;
    const newValue = parseInt(newHex, 16);
    const currentValue = pageData[targetOffset];
    const needErase = (currentValue & newValue) !== currentValue;

    addLog('ç”¨æˆ·æ„å›¾: å†™å…¥ 1 å­—èŠ‚åˆ°åç§» ' + targetOffset, 'info');
    document.getElementById('userIntent').textContent = '1';

    if (needErase) {
        // éœ€è¦æ“¦é™¤
        addLog('æ£€æµ‹åˆ°éœ€è¦æ“¦é™¤...', 'info');

        // æ“¦é™¤åŠ¨ç”»
        isAnimating = true;
        await erasePage();

        // å†™å…¥
        await performWrite(newValue);

        isAnimating = false;
    } else {
        // ç›´æ¥å†™å…¥
        addLog('å¯ä»¥ç›´æ¥å†™å…¥ï¼Œæ— éœ€æ“¦é™¤', 'info');
        isAnimating = true;
        await performWrite(newValue);
        isAnimating = false;
    }
}

// æ“¦é™¤Page
async function erasePage() {
    addLog('ğŸ§¹ å¼€å§‹æ“¦é™¤ Page #0 (256å­—èŠ‚)...', 'erase');

    // æ“¦é™¤åŠ¨ç”»
    for (let i = 0; i < 256; i++) {
        const cells = document.querySelectorAll('.grid-cell');
        cells[i].classList.add('erasing');

        await sleep(2);

        cells[i].classList.remove('erasing');
        pageData[i] = 0xFF;
        cells[i].textContent = 'FF';
        cells[i].classList.remove('data-written');
    }

    eraseCount++;
    document.getElementById('actualErase').textContent = '256';
    updateDisplay();

    addLog('âœ… Pageæ“¦é™¤å®Œæˆï¼æ“¦é™¤äº† 256 å­—èŠ‚', 'erase');
}

// æ‰§è¡Œå†™å…¥
async function performWrite(newValue) {
    addLog('âœï¸ å¼€å§‹å†™å…¥æ•°æ®...', 'write');

    const cells = document.querySelectorAll('.grid-cell');
    cells[targetOffset].classList.add('writing');

    await sleep(300);

    pageData[targetOffset] = newValue;
    updateDisplay();

    document.getElementById('actualWrite').textContent = '256';

    const amp = Math.round(256 / 1);
    document.getElementById('amplification').textContent = amp + 'x';

    addLog('âœ… å†™å…¥å®Œæˆï¼', 'write');
    addLog('ğŸ“Š å†™æ”¾å¤§å€æ•°: ' + amp + 'x (ä¿®æ”¹1å­—èŠ‚ï¼Œæ“¦é™¤256å­—èŠ‚)', 'info');
}

// æ·»åŠ æ—¥å¿—
function addLog(message, type = 'info') {
    const log = document.getElementById('operationLog');
    const entry = document.createElement('div');
    entry.className = 'log-entry ' + type;
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

    if (log.querySelector('.text-muted')) {
        log.innerHTML = '';
    }

    log.insertBefore(entry, log.firstChild);

    // é™åˆ¶æ—¥å¿—æ•°é‡
    while (log.children.length > 20) {
        log.removeChild(log.lastChild);
    }
}

// è¾…åŠ©å‡½æ•°
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// äº‹ä»¶ç›‘å¬
document.getElementById('offsetSlider').addEventListener('input', function() {
    selectOffset(parseInt(this.value));
});

document.getElementById('newDataSelect').addEventListener('change', function() {
    updateAnalysis();
});

// é¡µé¢åŠ è½½åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initPage();
});
</script>
{% endblock %}
