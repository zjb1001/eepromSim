{% extends "base.html" %}

{% block title %}WriteAllä¸€è‡´æ€§ - æ‰ç”µæ‹¯æ•‘è€…{% endblock %}

{% block content %}
<div class="page-shell container-fluid h-100 d-flex flex-column">
    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <div class="mb-3">
        <h2 class="mb-2">âš¡ æ‰ç”µæ‹¯æ•‘è€…: ä¸¤é˜¶æ®µæäº¤å¤§å†’é™©ï¼</h2>
        <div class="alert alert-warning mb-0">
            <strong>ğŸ¯ å®éªŒç›®æ ‡:</strong> æ¨¡æ‹Ÿå†™æ“ä½œè¿‡ç¨‹ä¸­çš„çªç„¶æ‰ç”µï¼Œè§‚å¯ŸWriteAllæœºåˆ¶å¦‚ä½•æ‹¯æ•‘æ•°æ®ï¼<br>
            <small>æŒ‘æˆ˜ï¼šåœ¨ä¸åŒæ—¶æœºç‚¹å‡»"âš¡æ‰ç”µ"æŒ‰é’®ï¼Œçœ‹æ•°æ®èƒ½å¦è¢«æˆåŠŸæ¢å¤ï¼</small>
        </div>
    </div>

    <!-- å·¦å³å¸ƒå±€: å·¦ä¾§å¯è§†åŒ–ï¼Œå³ä¾§æ“ä½œ -->
    <div class="row flex-grow-1 g-3">
        <!-- å·¦ä¾§: å¯è§†åŒ–åŒºåŸŸ (58%) -->
        <div class="col-lg-7">
            <div class="d-flex flex-column gap-3 h-100">
                <!-- Phase 1: RAM + å¿«ç…§åŒº -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">ğŸ“¸ Phase 1: å¿«ç…§åˆ›å»º</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="text-center flex-fill">
                                <h6>RAMä¸­çš„æ•°æ®</h6>
                                <div id="ramData" class="data-box bg-light border p-2 mx-auto" style="width: fit-content;">
                                    <div class="byte-grid-mini">
                                        <!-- 16å­—èŠ‚å¯è§†åŒ– -->
                                    </div>
                                </div>
                            </div>
                            <div class="text-center px-3">
                                <div class="arrow-animation">â†’â†’â†’</div>
                                <small class="text-muted">æŒä¹…åŒ–</small>
                            </div>
                            <div class="text-center flex-fill">
                                <h6>å¿«ç…§åŒº</h6>
                                <div id="snapshotData" class="data-box bg-warning border p-2 mx-auto" style="width: fit-content;">
                                    <div class="byte-grid-mini">
                                        <!-- 16å­—èŠ‚å¯è§†åŒ– -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="phase1Status" class="alert alert-secondary mb-2">
                            ç­‰å¾…å¼€å§‹...
                        </div>

                        <button id="phase1Btn" class="btn btn-primary w-100" onclick="executePhase1()" disabled>
                            ğŸš€ æ‰§è¡ŒPhase 1
                        </button>
                    </div>
                </div>

                <!-- Phase 2: å¿«ç…§åŒº â†’ ç›®æ ‡Block -->
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">ğŸ“ Phase 2: æ•°æ®å¤åˆ¶</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="text-center flex-fill">
                                <h6>å¿«ç…§åŒº</h6>
                                <div id="snapshotData2" class="data-box bg-warning border p-2 mx-auto" style="width: fit-content;">
                                    <div class="byte-grid-mini">
                                        <!-- 16å­—èŠ‚å¯è§†åŒ– -->
                                    </div>
                                </div>
                            </div>
                            <div class="text-center px-3">
                                <div class="arrow-animation">â†’â†’â†’</div>
                                <small class="text-muted">å¤åˆ¶+æ ¡éªŒ</small>
                            </div>
                            <div class="text-center flex-fill">
                                <h6>ç›®æ ‡Block</h6>
                                <div id="targetBlock" class="data-box bg-light border p-2 mx-auto" style="width: fit-content;">
                                    <div class="byte-grid-mini">
                                        <!-- 16å­—èŠ‚å¯è§†åŒ– -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="phase2Status" class="alert alert-secondary mb-2">
                            ç­‰å¾…Phase 1å®Œæˆ...
                        </div>

                        <button id="phase2Btn" class="btn btn-success w-100" onclick="executePhase2()" disabled>
                            ğŸ“ æ‰§è¡ŒPhase 2
                        </button>
                    </div>
                </div>

                <!-- æ‰ç”µæ•ˆæœæ˜¾ç¤º -->
                <div id="powerLossEffect" style="display:none;">
                    <div class="alert alert-danger text-center">
                        <h4>âš¡âš¡âš¡ çªç„¶æ‰ç”µï¼ï¼ï¼âš¡âš¡âš¡</h4>
                        <p>å±å¹•é—ªçƒ...ç³»ç»Ÿå´©æºƒ...</p>
                    </div>
                </div>

                <!-- æ¢å¤ç»“æœæ˜¾ç¤º -->
                <div id="recoveryResult" class="card" style="display:none;">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">ğŸ”§ æ¢å¤ç»“æœ</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>æ‰ç”µæ—¶æœº:</strong> <span id="plTiming"></span></p>
                        <p><strong>æ¢å¤ç­–ç•¥:</strong> <span id="recoveryStrategy"></span></p>
                        <p><strong>æ•°æ®çŠ¶æ€:</strong> <span id="dataState"></span></p>
                        <p><strong>æ¢å¤ç»“æœ:</strong> <span id="recoveryOutcome"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§: æ“ä½œé¢æ¿ (42%) -->
        <div class="col-lg-5">
            <div class="d-flex flex-column gap-3 h-100">
                <!-- æ¨¡å¼é€‰æ‹©å¡ç‰‡ -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">ğŸ® å®éªŒæ¨¡å¼</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2 mb-3">
                            <button class="btn btn-info" onclick="startMode('learning')">
                                ğŸ“ å­¦ä¹ æ¨¡å¼
                            </button>
                            <button class="btn btn-danger" onclick="startMode('challenge')">
                                ğŸ”¥ æ‰ç”µæŒ‘æˆ˜
                            </button>
                        </div>

                        <div class="row">
                            <div class="col-6">
                                <label class="form-label small">åŠ¨ç”»é€Ÿåº¦:</label>
                                <select id="speedSelect" class="form-select form-select-sm">
                                    <option value="1000">æ…¢é€Ÿ</option>
                                    <option value="500" selected>æ­£å¸¸</option>
                                    <option value="100">å¿«é€Ÿ</option>
                                </select>
                            </div>
                            <div class="col-6 text-end">
                                <button class="btn btn-secondary btn-sm w-100" onclick="resetSim()">
                                    ğŸ”„ é‡ç½®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ‰ç”µæ§åˆ¶å° -->
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">âš¡ æ‰ç”µæ§åˆ¶å°</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <small>æ‰ç”µæ¬¡æ•°</small>
                                <h3 class="text-danger mb-0" id="powerLossCount">0</h3>
                            </div>
                            <div class="col-6">
                                <small>æˆåŠŸæ¢å¤</small>
                                <h3 class="text-success mb-0" id="recoveryCount">0</h3>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-danger btn-sm" onclick="powerLoss('before_phase1')">
                                âš¡ Phase 1ä¹‹å‰
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="powerLoss('during_phase1')">
                                âš¡ Phase 1è¿›è¡Œä¸­
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="powerLoss('after_phase1')">
                                âš¡ Phase 1ä¹‹å
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="powerLoss('during_phase2')">
                                âš¡ Phase 2è¿›è¡Œä¸­
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="powerLoss('after_phase2')">
                                âš¡ Phase 2ä¹‹å
                            </button>
                        </div>
                    </div>
                </div>

                <!-- è„æ•°æ®æ£€æµ‹ -->
                <div class="card">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">ğŸ” è„æ•°æ®æ£€æµ‹</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input type="checkbox" id="dirtyDataCheck" class="form-check-input">
                            <label class="form-check-label small" for="dirtyDataCheck">
                                æ¨¡æ‹Ÿè„æ•°æ® - Phase 1åä¿®æ”¹RAM
                            </label>
                        </div>

                        <div id="dirtyDataResult" class="alert alert-secondary mb-0" style="display:none; font-size: 12px;">
                            <strong>ğŸš¨ è„æ•°æ®æ£€æµ‹ç»“æœ:</strong><br>
                            <strong>å¿«ç…§CRC:</strong> <code id="snapshotCrc"></code><br>
                            <strong>å½“å‰RAM CRC:</strong> <code id="ramCrc"></code><br>
                            <strong>æ£€æµ‹ç»“æœ:</strong> <span id="dirtyCheckResult"></span>
                        </div>
                    </div>
                </div>

                <!-- äº‹ä»¶æ—¥å¿— -->
                <div class="card flex-grow-1">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">ğŸ“‹ äº‹ä»¶æ—¥å¿—</h5>
                    </div>
                    <div class="card-body" style="max-height: 200px; overflow-y: auto; font-size: 12px;">
                        <div id="eventLog">
                            <p class="text-muted text-center">ç­‰å¾…å®éªŒå¼€å§‹...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æˆåŠŸåº†ç¥æ¨¡æ€æ¡† -->
<div class="modal" id="challengeCompleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">ğŸ‰ æŒ‘æˆ˜å®Œæˆï¼</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>âœ… ä½ å®Œæˆäº†æ‰ç”µæŒ‘æˆ˜ï¼</h6>
                <div id="challengeSummary"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    ç»§ç»­æ¢ç´¢
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* ç¡®ä¿ä¸»è¦å†…å®¹åŒºåŸŸå……æ»¡å¯ç”¨ç©ºé—´ï¼Œä½†ä¸å½±å“å¯¼èˆªæ å®¹å™¨ */
.page-shell {
    min-height: calc(100vh - 100px);
}

/* æ•°æ®æ¡† */
.data-box {
    min-height: 80px;
    min-width: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: all 0.3s;
    border-radius: 8px;
}

.byte-grid-mini {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 0;
    font-size: 7px;
    font-family: monospace;
    max-width: 100%;
}

.byte-cell {
    width: 12px;
    height: 12px;
    background: #e0e0e0;
    border: 1px solid #999;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.byte-cell.active {
    background: #007bff;
    border-color: #0056b3;
    color: white;
    animation: byte-write 0.3s;
}

.byte-cell.snapshot {
    background: #ffc107;
    border-color: #d39e00;
    color: #000;
}

.byte-cell.target {
    background: #28a745;
    border-color: #1e7e34;
    color: white;
}

@keyframes byte-write {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); background: #00ffff; }
    100% { transform: scale(1); }
}

.arrow-animation {
    font-size: 28px;
    color: #6c757d;
    animation: arrow-flow 1s infinite;
}

@keyframes arrow-flow {
    0%, 100% { opacity: 0.3; transform: translateX(0); }
    50% { opacity: 1; transform: translateX(5px); }
}

.power-loss-flash {
    animation: flash 0.5s;
}

@keyframes flash {
    0%, 100% { background: white; }
    25% { background: #ff0000; }
    50% { background: #ffffff; }
    75% { background: #ff0000; }
}

/* æ—¥å¿—æ ·å¼ */
.log-entry {
    padding: 6px 8px;
    margin-bottom: 4px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 11px;
    border-left: 3px solid #007bff;
}

.log-phase1 { background: #d1ecf1; border-left-color: #17a2b8; }
.log-phase2 { background: #d4edda; border-left-color: #28a745; }
.log-powerloss { background: #f8d7da; border-left-color: #dc3545; }
.log-recovery { background: #cce5ff; border-left-color: #004085; }
.log-dirty { background: #fff3cd; border-left-color: #ffc107; }

/* å“åº”å¼ */
@media (max-width: 991px) {
    .page-shell {
        min-height: auto;
    }

    .data-box {
        min-width: 150px;
    }

    .byte-cell {
        width: 15px;
        height: 15px;
        font-size: 9px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentPhase = 'IDLE';
let ramData = [];
let snapshotData = [];
let targetData = [];
let powerLossCount = 0;
let recoveryCount = 0;
let currentMode = null;
let phase1Complete = false;
let phase2Complete = false;

// åˆå§‹åŒ–
function init() {
    resetData();
    addLog('ğŸš€ WriteAllæ‰ç”µå®éªŒç³»ç»Ÿå·²å¯åŠ¨', 'info');
}

// é‡ç½®æ•°æ®
function resetData() {
    // åˆå§‹åŒ–éšæœºæ•°æ®
    ramData = [];
    for (let i = 0; i < 16; i++) {
        ramData.push(0x55); // åˆå§‹æ•°æ®
    }
    snapshotData = [];
    targetData = [];
    updateDisplay();
}

// å¼€å§‹æ¨¡å¼
function startMode(mode) {
    currentMode = mode;
    resetSim();

    if (mode === 'learning') {
        addLog('ğŸ“ å¼€å§‹å­¦ä¹ æ¨¡å¼', 'info');
        document.getElementById('phase1Btn').disabled = false;
    } else if (mode === 'challenge') {
        addLog('ğŸ”¥ å¼€å§‹æ‰ç”µæŒ‘æˆ˜æ¨¡å¼', 'info');
        document.getElementById('phase1Btn').disabled = false;
    }
}

// æ‰§è¡ŒPhase 1
async function executePhase1() {
    if (currentPhase !== 'IDLE') return;

    currentPhase = 'PHASE1';
    document.getElementById('phase1Status').className = 'alert alert-info';
    document.getElementById('phase1Status').innerHTML = 'ğŸš€ Phase 1 è¿›è¡Œä¸­ï¼šåˆ›å»ºå¿«ç…§...';
    addLog('ğŸ“¸ å¼€å§‹Phase 1: åˆ›å»ºå¿«ç…§', 'phase1');

    const speed = parseInt(document.getElementById('speedSelect').value);

    // ç”Ÿæˆæ–°æ•°æ®
    const newData = [];
    for (let i = 0; i < 16; i++) {
        newData.push(Math.floor(Math.random() * 256));
    }
    ramData = newData;

    updateDisplay();
    await sleep(speed);

    // åˆ›å»ºå¿«ç…§
    snapshotData = [...ramData];
    addLog(`âœ… å¿«ç…§å·²åˆ›å»º: ${snapshotData.slice(0, 4).map(b => '0x' + b.toString(16).toUpperCase()).join(' ')}...`, 'phase1');

    // æ˜¾ç¤ºå¿«ç…§æ•°æ®
    updateDisplay();
    await sleep(speed / 2);

    // æŒä¹…åŒ–å¿«ç…§
    addLog('ğŸ’¾ å¿«ç…§å·²æŒä¹…åŒ–åˆ°EEPROM', 'phase1');

    currentPhase = 'PHASE1_COMPLETE';
    phase1Complete = true;

    document.getElementById('phase1Status').className = 'alert alert-success';
    document.getElementById('phase1Status').innerHTML = 'âœ… Phase 1 å®Œæˆï¼šå¿«ç…§å·²æŒä¹…åŒ–';
    document.getElementById('phase2Btn').disabled = false;

    // æŒ‘æˆ˜æ¨¡å¼è‡ªåŠ¨æ‰ç”µ
    if (currentMode === 'challenge') {
        if (Math.random() < 0.3) {
            await sleep(500);
            powerLoss('after_phase1');
        }
    }
}

// æ‰§è¡ŒPhase 2
async function executePhase2() {
    if (currentPhase !== 'PHASE1_COMPLETE') return;

    currentPhase = 'PHASE2';
    document.getElementById('phase2Status').className = 'alert alert-info';
    document.getElementById('phase2Status').innerHTML = 'ğŸ“ Phase 2 è¿›è¡Œä¸­ï¼šå¤åˆ¶æ•°æ®...';
    addLog('ğŸ“ å¼€å§‹Phase 2: å¤åˆ¶æ•°æ®åˆ°ç›®æ ‡Block', 'phase2');

    const speed = parseInt(document.getElementById('speedSelect').value);

    // æ£€æŸ¥è„æ•°æ®
    if (document.getElementById('dirtyDataCheck').checked) {
        // æ¨¡æ‹ŸRAMè¢«ä¿®æ”¹
        ramData[0] = 0xFF;
        ramData[1] = 0xFF;

        // æ˜¾ç¤ºè„æ•°æ®æ£€æµ‹ç»“æœ
        const snapshotCrc = calculateCRC(snapshotData);
        const ramCrc = calculateCRC(ramData);

        document.getElementById('snapshotCrc').textContent = snapshotCrc;
        document.getElementById('ramCrc').textContent = ramCrc;
        document.getElementById('dirtyCheckResult').innerHTML = '<span class="badge bg-danger">âŒ CRCä¸åŒ¹é…ï¼æ£€æµ‹åˆ°è„æ•°æ®</span>';
        document.getElementById('dirtyDataResult').style.display = 'block';

        addLog('ğŸš¨ æ£€æµ‹åˆ°è„æ•°æ®ï¼CRCä¸åŒ¹é…ï¼Œæ‹’ç»å†™å…¥', 'dirty');
        addLog(`å¿«ç…§CRC: ${snapshotCrc}, RAM CRC: ${ramCrc}`, 'dirty');

        currentPhase = 'DIRTY_DATA_DETECTED';
        document.getElementById('phase2Status').className = 'alert alert-danger';
        document.getElementById('phase2Status').innerHTML = 'ğŸš¨ è„æ•°æ®æ£€æµ‹å¤±è´¥ï¼';
        return;
    }

    updateDisplay();
    await sleep(speed);

    // å¤åˆ¶æ•°æ®
    targetData = [...snapshotData];
    addLog(`ğŸ“‹ å¤åˆ¶ ${targetData.length} å­—èŠ‚åˆ°ç›®æ ‡Block`, 'phase2');

    updateDisplay();
    await sleep(speed);

    // æ ¡éªŒCRC
    const snapshotCrc = calculateCRC(snapshotData);
    const targetCrc = calculateCRC(targetData);

    addLog(`ğŸ” æ ¡éªŒCRC: å¿«ç…§=${snapshotCrc}, ç›®æ ‡=${targetCrc}`, 'phase2');
    await sleep(speed / 2);

    if (snapshotCrc === targetCrc) {
        addLog('âœ… CRCæ ¡éªŒé€šè¿‡ï¼æ•°æ®ä¸€è‡´', 'phase2');
        currentPhase = 'PHASE2_COMPLETE';
        phase2Complete = true;

        document.getElementById('phase2Status').className = 'alert alert-success';
        document.getElementById('phase2Status').innerHTML = 'âœ… Phase 2 å®Œæˆï¼šæ•°æ®å·²å†™å…¥å¹¶æ ¡éªŒ';

        // æŒ‘æˆ˜æ¨¡å¼æˆåŠŸ
        if (currentMode === 'challenge') {
            showChallengeComplete();
        }
    } else {
        addLog('âŒ CRCæ ¡éªŒå¤±è´¥ï¼', 'phase2');
        document.getElementById('phase2Status').className = 'alert alert-danger';
        document.getElementById('phase2Status').innerHTML = 'âŒ CRCæ ¡éªŒå¤±è´¥ï¼';
    }
}

// æ‰ç”µæ¨¡æ‹Ÿ
async function powerLoss(timing) {
    powerLossCount++;
    document.getElementById('powerLossCount').textContent = powerLossCount;

    // æ‰ç”µæ•ˆæœ
    const effect = document.getElementById('powerLossEffect');
    effect.style.display = 'block';
    document.body.classList.add('power-loss-flash');

    addLog(`âš¡âš¡âš¡ çªç„¶æ‰ç”µï¼æ—¶æœº: ${timing}`, 'powerloss');

    await sleep(1000);

    effect.style.display = 'none';
    document.body.classList.remove('power-loss-flash');

    // æ¢å¤é€»è¾‘
    let recoveryStrategy = '';
    let dataState = '';
    let recoveryOutcome = '';
    let success = false;

    switch(timing) {
        case 'before_phase1':
            recoveryStrategy = 'æ— å¿«ç…§ï¼Œä½¿ç”¨æ—§æ•°æ®';
            dataState = 'ç›®æ ‡Blockä¿æŒåŸå€¼';
            recoveryOutcome = 'âœ… æ•°æ®ä¸€è‡´ï¼ˆæ—§æ•°æ®ï¼‰';
            success = true;
            break;

        case 'during_phase1':
            recoveryStrategy = 'å¿«ç…§ä¸å®Œæ•´ï¼Œä½¿ç”¨æ—§æ•°æ®';
            dataState = 'ç›®æ ‡Blockä¿æŒåŸå€¼';
            recoveryOutcome = 'âœ… æ•°æ®ä¸€è‡´ï¼ˆæ—§æ•°æ®ï¼‰';
            success = true;
            break;

        case 'after_phase1':
            recoveryStrategy = 'ä½¿ç”¨å¿«ç…§æ¢å¤';
            dataState = 'å¿«ç…§å®Œæ•´å¯ç”¨';
            recoveryOutcome = 'âœ… æ•°æ®æ¢å¤åˆ°å¿«ç…§çŠ¶æ€';
            targetData = [...snapshotData];
            recoveryCount++;
            success = true;
            break;

        case 'during_phase2':
            recoveryStrategy = 'ä½¿ç”¨å¿«ç…§æ¢å¤ï¼ˆé‡è¯•Phase 2ï¼‰';
            dataState = 'ç›®æ ‡Blockå¯èƒ½ä¸å®Œæ•´ï¼Œé‡æ–°æ‰§è¡ŒPhase 2';
            recoveryOutcome = 'âœ… æ•°æ®æ¢å¤ï¼ˆé‡å†™ï¼‰';
            targetData = [...snapshotData];
            recoveryCount++;
            success = true;
            break;

        case 'after_phase2':
            recoveryStrategy = 'ä½¿ç”¨ç›®æ ‡Blockæ•°æ®';
            dataState = 'ç›®æ ‡Blockå·²å®Œæ•´å†™å…¥';
            recoveryOutcome = 'âœ… æ•°æ®ä¸€è‡´ï¼ˆæ–°æ•°æ®ï¼‰';
            success = true;
            break;
    }

    if (success) {
        document.getElementById('recoveryCount').textContent = recoveryCount;
    }

    // æ˜¾ç¤ºæ¢å¤ç»“æœ
    const timingNames = {
        'before_phase1': 'Phase 1ä¹‹å‰',
        'during_phase1': 'Phase 1è¿›è¡Œä¸­',
        'after_phase1': 'Phase 1ä¹‹å',
        'during_phase2': 'Phase 2è¿›è¡Œä¸­',
        'after_phase2': 'Phase 2ä¹‹å'
    };

    document.getElementById('plTiming').textContent = timingNames[timing];
    document.getElementById('recoveryStrategy').textContent = recoveryStrategy;
    document.getElementById('dataState').textContent = dataState;
    document.getElementById('recoveryOutcome').innerHTML = `<span class="badge bg-${success ? 'success' : 'danger'}">${recoveryOutcome}</span>`;
    document.getElementById('recoveryResult').style.display = 'block';

    addLog(`ğŸ”§ æ¢å¤ç­–ç•¥: ${recoveryStrategy}`, 'recovery');
    addLog(`ğŸ“Š æ¢å¤ç»“æœ: ${recoveryOutcome}`, 'recovery');

    updateDisplay();
}

// æ›´æ–°æ˜¾ç¤º
function updateDisplay() {
    // æ›´æ–°RAMæ•°æ®
    updateDataBox('ramData', ramData, 'active');
    updateDataBox('snapshotData', snapshotData, 'snapshot');
    updateDataBox('snapshotData2', snapshotData, 'snapshot');
    updateDataBox('targetBlock', targetData, 'target');
}

// æ›´æ–°æ•°æ®æ¡†
function updateDataBox(elementId, data, cellClass) {
    const element = document.getElementById(elementId);
    const grid = element.querySelector('.byte-grid-mini');

    if (data.length === 0) {
        grid.innerHTML = '<div class="text-muted text-center w-100">ç©º</div>';
        return;
    }

    grid.innerHTML = data.map((byte, idx) => `
        <div class="byte-cell ${cellClass}" title="0x${byte.toString(16).toUpperCase()}">
            ${byte.toString(16).toUpperCase().padStart(2, '0')}
        </div>
    `).join('');
}

// è®¡ç®—CRC16
function calculateCRC(data) {
    let crc = 0xFFFF;
    for (let byte of data) {
        crc ^= byte << 8;
        for (let i = 0; i < 8; i++) {
            if (crc & 0x8000) {
                crc = (crc << 1) ^ 0x1021;
            } else {
                crc = crc << 1;
            }
        }
    }
    return '0x' + (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
}

// æ·»åŠ æ—¥å¿—
function addLog(message, type = 'info') {
    const log = document.getElementById('eventLog');
    const entry = document.createElement('div');
    entry.className = `log-entry log-${type}`;
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

    if (log.querySelector('.text-muted')) {
        log.innerHTML = '';
    }

    log.insertBefore(entry, log.firstChild);

    // é™åˆ¶æ—¥å¿—æ•°é‡
    while (log.children.length > 50) {
        log.removeChild(log.lastChild);
    }
}

// æ˜¾ç¤ºæŒ‘æˆ˜å®Œæˆ
function showChallengeComplete() {
    const modal = new bootstrap.Modal(document.getElementById('challengeCompleteModal'));

    const successRate = powerLossCount > 0 ? ((recoveryCount / powerLossCount) * 100).toFixed(0) : 100;

    const summary = `
        <p>ä½ å®Œæˆäº†æ‰ç”µæŒ‘æˆ˜ï¼</p>
        <ul>
            <li>âš¡ æ‰ç”µæ¬¡æ•°: ${powerLossCount}</li>
            <li>âœ… æˆåŠŸæ¢å¤: ${recoveryCount}</li>
            <li>ğŸ“Š æ¢å¤æˆåŠŸç‡: ${successRate}%</li>
            <li>ğŸ“š çŸ¥è¯†ç‚¹: WriteAllçš„ä¸¤é˜¶æ®µæäº¤æœºåˆ¶ç¡®ä¿æ•°æ®ä¸€è‡´æ€§</li>
        </ul>
        <p><strong>å³ä½¿æ‰ç”µï¼Œæ•°æ®ä¹Ÿä¸ä¼šæŸåï¼</strong></p>
    `;

    document.getElementById('challengeSummary').innerHTML = summary;
    modal.show();
}

// é‡ç½®
function resetSim() {
    currentPhase = 'IDLE';
    phase1Complete = false;
    phase2Complete = false;
    resetData();

    document.getElementById('phase1Status').className = 'alert alert-secondary';
    document.getElementById('phase1Status').innerHTML = 'ç­‰å¾…å¼€å§‹...';
    document.getElementById('phase2Status').className = 'alert alert-secondary';
    document.getElementById('phase2Status').innerHTML = 'ç­‰å¾…Phase 1å®Œæˆ...';
    document.getElementById('phase1Btn').disabled = true;
    document.getElementById('phase2Btn').disabled = true;
    document.getElementById('recoveryResult').style.display = 'none';
    document.getElementById('dirtyDataResult').style.display = 'none';

    addLog('ğŸ”„ ç³»ç»Ÿå·²é‡ç½®', 'info');
}

// è¾…åŠ©å‡½æ•°
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// é¡µé¢åŠ è½½åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    init();
});
</script>
{% endblock %}
