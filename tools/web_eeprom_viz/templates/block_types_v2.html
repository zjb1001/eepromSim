{% extends "base.html" %}

{% block title %}Blockç±»å‹å¯¹æ¯” - æ•°æ®ä¿é™©æŸœ{% endblock %}

{% block content %}
<div class="page-shell container-fluid">
    <h2 class="mb-4">ğŸ” æ•°æ®ä¿é™©æŸœ: ç¾éš¾ç”Ÿå­˜æŒ‘æˆ˜ï¼</h2>

    <!-- æ ¸å¿ƒæ¦‚å¿µ -->
    <div class="alert alert-danger mb-4">
        <strong>ğŸ¯ å®éªŒç›®æ ‡:</strong> åœ¨ç«ç¾ğŸ”¥ã€åœ°éœ‡ğŸŒ‹ã€é»‘å®¢ğŸ’»æ”»å‡»ä¸­ï¼Œçœ‹å“ªç§Blockç±»å‹èƒ½ä¿æŠ¤æ•°æ®ï¼<br>
        <small>æŒ‘æˆ˜ï¼šä¸ºä¸åŒç±»å‹çš„æ•°æ®é€‰æ‹©æœ€åˆé€‚çš„ä¿é™©æŸœï¼Œå¹¶æµ‹è¯•å®ƒä»¬çš„ç”Ÿå­˜èƒ½åŠ›ï¼</small>
    </div>

    <!-- æ¸¸æˆæ¨¡å¼é€‰æ‹© -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ® é€‰æ‹©æŒ‘æˆ˜æ¨¡å¼</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <strong>ğŸ“š å­¦ä¹ æ¨¡å¼</strong>
                                </div>
                                <div class="card-body">
                                    <p>å¯¹æ¯”ä¸‰ç§ä¿é™©æŸœ</p>
                                    <ul class="small mb-0">
                                        <li>äº†è§£å­˜å‚¨æœºåˆ¶</li>
                                        <li>å¯¹æ¯”æ¢å¤èƒ½åŠ›</li>
                                        <li>ç†è§£é€‚ç”¨åœºæ™¯</li>
                                    </ul>
                                    <button class="btn btn-info w-100 mt-2" onclick="startMode('learning')">
                                        ğŸ“ å¼€å§‹å­¦ä¹ 
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <strong>ğŸ”¥ ç¾éš¾æµ‹è¯•</strong>
                                </div>
                                <div class="card-body">
                                    <p>æµ‹è¯•ä¸‰ç§ä¿é™©æŸœæé™</p>
                                    <ul class="small mb-0">
                                        <li>ç«ç¾/åœ°éœ‡/é»‘å®¢</li>
                                        <li>çœ‹è°å­˜æ´»</li>
                                        <li>è¯„åˆ†ç³»ç»Ÿ</li>
                                    </ul>
                                    <button class="btn btn-warning w-100 mt-2" onclick="startMode('disaster')">
                                        ğŸ’¥ å¼€å§‹æµ‹è¯•
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 mb-3">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <strong>ğŸ’° é‡‘å¸ä¿å­˜</strong>
                                </div>
                                <div class="card-body">
                                    <p>ä¸ºé‡‘å¸é€‰æ‹©ä¿é™©æŸœ</p>
                                    <ul class="small mb-0">
                                        <li>æ¨¡æ‹ŸçœŸå®åœºæ™¯</li>
                                        <li>æµ‹è¯•é€‰æ‹©æ­£ç¡®æ€§</li>
                                        <li>è·å¾—é‡‘å¸å¥–åŠ±</li>
                                    </ul>
                                    <button class="btn btn-success w-100 mt-2" onclick="startMode('coin')">
                                        ğŸ’° ä¿å­˜é‡‘å¸
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸‰ç§ä¿é™©æŸœå¯è§†åŒ– -->
    <div class="row mb-4">
        <div class="col-md-4">
            <!-- Native Block -->
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">âŒ Nativeä¿é™©æŸœ</h5>
                    <small>å•ä»½æ•°æ®ï¼Œæ— å¤‡ä»½</small>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div id="nativeSafe" class="safe-viz">
                            ğŸ“¦<br>
                            <small>å•å±‚ä¿é™©æŸœ</small>
                        </div>
                    </div>
                    <div class="data-display" id="nativeData">
                        <p class="text-muted">æ— æ•°æ®</p>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <small>å­˜å‚¨å¼€é”€</small>
                            <div><strong>1x</strong></div>
                        </div>
                        <div class="col-6">
                            <small>æ¢å¤èƒ½åŠ›</small>
                            <div><strong class="text-danger">æ— </strong></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Redundant Block -->
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">âœ… Redundantä¿é™©æŸœ</h5>
                    <small>åŒä»½å¤‡ä»½ï¼Œäº’ä¸ºçƒ­å¤‡</small>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div id="redundantSafe" class="safe-viz">
                            ğŸ“¦ğŸ“¦<br>
                            <small>åŒå±‚ä¿é™©æŸœ</small>
                        </div>
                    </div>
                    <div class="data-display" id="redundantData">
                        <p class="text-muted">æ— æ•°æ®</p>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <small>å­˜å‚¨å¼€é”€</small>
                            <div><strong>2x</strong></div>
                        </div>
                        <div class="col-6">
                            <small>æ¢å¤èƒ½åŠ›</small>
                            <div><strong class="text-success">å¤‡ä»½</strong></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Dataset Block -->
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">â­ Datasetä¿é™©æŸœ</h5>
                    <small>å¤šç‰ˆæœ¬ç®¡ç†ï¼Œå¯å›é€€</small>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div id="datasetSafe" class="safe-viz">
                            ğŸ“¦ğŸ“¦ğŸ“¦<br>
                            <small>ä¸‰å±‚ä¿é™©æŸœ</small>
                        </div>
                    </div>
                    <div class="data-display" id="datasetData">
                        <p class="text-muted">æ— æ•°æ®</p>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <small>å­˜å‚¨å¼€é”€</small>
                            <div><strong>Nx</strong></div>
                        </div>
                        <div class="col-6">
                            <small>æ¢å¤èƒ½åŠ›</small>
                            <div><strong class="text-success">å¤šç‰ˆæœ¬</strong></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¾éš¾æµ‹è¯•æ§åˆ¶å° -->
    <div class="row mb-4" id="disasterControls" style="display:none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-danger">
                    <h5 class="mb-0">ğŸ’¥ ç¾éš¾æµ‹è¯•æ§åˆ¶å°</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="text-muted">ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æ¨¡æ‹Ÿä¸åŒç±»å‹çš„ç¾éš¾ï¼š</p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-danger btn-lg" onclick="triggerDisaster('fire')">
                                    ğŸ”¥ ç«ç¾ç¾éš¾ - éšæœºæŸå1ä¸ªä¿é™©æŸœ
                                </button>
                                <button class="btn btn-outline-dark btn-lg" onclick="triggerDisaster('earthquake')">
                                    ğŸŒ‹ åœ°éœ‡ç¾éš¾ - éšæœºæŸå2ä¸ªä¿é™©æŸœ
                                </button>
                                <button class="btn btn-outline-secondary btn-lg" onclick="triggerDisaster('hacker')">
                                    ğŸ’» é»‘å®¢æ”»å‡» - æ¶æ„ä¿®æ”¹æ‰€æœ‰ä¿é™©æŸœ
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center">
                                <h6>å­˜æ´»ä¿é™©æŸœ</h6>
                                <h2 id="survivalCount">3/3</h2>
                                <hr>
                                <h6>æµ‹è¯•å¾—åˆ†</h6>
                                <h2 id="disasterScore">0</h2>
                            </div>
                        </div>
                    </div>

                    <!-- ç¾éš¾æ•ˆæœ -->
                    <div id="disasterEffect" class="mt-3" style="display:none;">
                        <div class="alert alert-danger text-center">
                            <h4 id="disasterTitle">ğŸ’¥ ç¾éš¾å‘ç”Ÿï¼ï¼ï¼</h4>
                            <p id="disasterDesc"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é‡‘å¸ä¿å­˜æ¸¸æˆ -->
    <div class="row mb-4" id="coinGame" style="display:none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">ğŸ’° é‡‘å¸ä¿å­˜æ¸¸æˆ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="text-muted">ä½ æœ‰<strong>100é‡‘å¸</strong>ï¼Œéœ€è¦ä¸ºå®ƒä»¬é€‰æ‹©æœ€åˆé€‚çš„ä¿é™©æŸœï¼</p>

                            <div class="mb-3">
                                <label class="form-label">æ•°æ®ç±»å‹:</label>
                                <select id="dataTypeSelect" class="form-select">
                                    <option value="temporary">ä¸´æ—¶æ•°æ®ï¼ˆæ—¥å¿—ï¼‰</option>
                                    <option value="important">é‡è¦æ•°æ®ï¼ˆé…ç½®ï¼‰</option>
                                    <option value="critical">å…³é”®æ•°æ®ï¼ˆå¯†ç ï¼‰</option>
                                    <option value="versioned">ç‰ˆæœ¬æ•°æ®ï¼ˆå†å²è®°å½•ï¼‰</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">é€‰æ‹©ä¿é™©æŸœ:</label>
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-outline-danger" onclick="selectSafe('native')">Native</button>
                                    <button class="btn btn-outline-warning" onclick="selectSafe('redundant')">Redundant</button>
                                    <button class="btn btn-outline-success" onclick="selectSafe('dataset')">Dataset</button>
                                </div>
                            </div>

                            <button class="btn btn-warning w-100" onclick="saveCoins()">
                                ğŸ’° ä¿å­˜é‡‘å¸
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center">
                                <h6>ğŸ’° å½“å‰é‡‘å¸</h6>
                                <h1 id="coinCount">100</h1>
                                <hr>
                                <h6>æ¨èä¿é™©æŸœ</h6>
                                <h3 id="recommendedSafe">?</h3>
                                <hr>
                                <h6>æ¸¸æˆå¾—åˆ†</h6>
                                <h3 id="gameScore">0</h3>
                            </div>
                        </div>
                    </div>

                    <!-- æ¸¸æˆç»“æœ -->
                    <div id="coinResult" class="mt-3" style="display:none;">
                        <div class="alert alert-info">
                            <h6>ğŸ“Š ä¿å­˜ç»“æœ:</h6>
                            <p><strong>ä½ çš„é€‰æ‹©:</strong> <span id="userChoice"></span></p>
                            <p><strong>æ¨èé€‰æ‹©:</strong> <span id="optimalChoice"></span></p>
                            <p><strong>ç»“æœ:</strong> <span id="saveResult"></span></p>
                            <p><strong>é‡‘å¸:</strong> <span id="coinResult"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨èç³»ç»Ÿ -->
    <div class="row mb-4" id="recommendationSystem" style="display:none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info">
                    <h5 class="mb-0">ğŸ¤– æ™ºèƒ½æ¨èç³»ç»Ÿ</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">æ ¹æ®æ•°æ®ç‰¹å¾ï¼Œè‡ªåŠ¨æ¨èæœ€åˆé€‚çš„Blockç±»å‹ï¼</p>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check mb-2">
                                <input type="checkbox" id="checkCritical" class="form-check-input" onchange="updateRecommendation()">
                                <label class="form-check-label" for="checkCritical">
                                    æ•°æ®æ˜¯å¦å…³é”®ï¼Ÿ
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input type="checkbox" id="checkVersion" class="form-check-input" onchange="updateRecommendation()">
                                <label class="form-check-label" for="checkVersion">
                                    éœ€è¦å†å²ç‰ˆæœ¬ï¼Ÿ
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input type="checkbox" id="checkFrequent" class="form-check-input" onchange="updateRecommendation()">
                                <label class="form-check-label" for="checkFrequent">
                                    é¢‘ç¹ä¿®æ”¹ï¼Ÿ
                                </label>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div id="recommendationResult" class="alert alert-secondary">
                                è¯·é€‰æ‹©æ•°æ®ç‰¹å¾...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- äº‹ä»¶æ—¥å¿— -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ“‹ äº‹ä»¶æ—¥å¿—</h5>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <div id="eventLog">
                        <p class="text-muted text-center">ç­‰å¾…å®éªŒå¼€å§‹...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸåº†ç¥æ¨¡æ€æ¡† -->
    <div class="modal" id="gameCompleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">ğŸ‰ æ¸¸æˆç»“æŸï¼</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>âœ… æŒ‘æˆ˜å®Œæˆï¼</h6>
                    <div id="gameSummary"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        ç»§ç»­æ¢ç´¢
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ç¡®ä¿ä¸»è¦å†…å®¹åŒºåŸŸå……æ»¡å¯ç”¨ç©ºé—´ï¼Œä½†ä¸å½±å“å¯¼èˆªæ å®¹å™¨ */
.page-shell {
    min-height: calc(100vh - 100px);
}

.safe-viz {
    font-size: 48px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.3s;
}

.safe-viz.damaged {
    background: #ffcccc;
    animation: shake 0.5s;
}

.safe-viz.safe {
    background: #ccffcc;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

.data-display {
    min-height: 60px;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
}

.disaster-flash {
    animation: disaster 0.5s;
}

@keyframes disaster {
    0%, 100% { background: white; }
    20% { background: #ff0000; }
    40% { background: #ffffff; }
    60% { background: #ff6600; }
    80% { background: #ffffff; }
}

.log-entry {
    padding: 8px 10px;
    margin-bottom: 5px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    border-left: 4px solid #007bff;
}

.log-disaster { background: #f8d7da; border-left-color: #dc3545; }
.log-recovery { background: #d4edda; border-left-color: #28a745; }
.log-coin { background: #fff3cd; border-left-color: #ffc107; }

/* å“åº”å¼ */
@media (max-width: 991px) {
    .page-shell {
        min-height: auto;
    }

    .safe-viz {
        font-size: 36px;
        padding: 15px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentMode = null;
let nativeData = [];
let redundantMain = [];
let redundantBackup = [];
let datasetVersions = [[], [], []];
let disasterScore = 0;
let gameScore = 0;
let coins = 100;
let selectedSafe = null;

// åˆå§‹åŒ–
function init() {
    resetData();
    addLog('ğŸš€ æ•°æ®ä¿é™©æŸœç³»ç»Ÿå·²å¯åŠ¨', 'info');
}

// é‡ç½®æ•°æ®
function resetData() {
    nativeData = [0xAA, 0xAA, 0xAA, 0xAA];
    redundantMain = [0xBB, 0xBB, 0xBB, 0xBB];
    redundantBackup = [0xBB, 0xBB, 0xBB, 0xBB];
    datasetVersions = [
        [0xCC, 0xCC, 0xCC, 0xCC],  // ç‰ˆæœ¬0ï¼ˆæœ€æ–°ï¼‰
        [0x11, 0x11, 0x11, 0x11],  // ç‰ˆæœ¬1
        [0x22, 0x22, 0x22, 0x22]   // ç‰ˆæœ¬2
    ];
    updateDisplay();
}

// å¼€å§‹æ¨¡å¼
function startMode(mode) {
    currentMode = mode;
    resetData();

    // éšè—æ‰€æœ‰é¢æ¿
    document.getElementById('disasterControls').style.display = 'none';
    document.getElementById('coinGame').style.display = 'none';
    document.getElementById('recommendationSystem').style.display = 'none';

    if (mode === 'learning') {
        addLog('ğŸ“ å¼€å§‹å­¦ä¹ æ¨¡å¼', 'info');
        document.getElementById('recommendationSystem').style.display = 'block';
    } else if (mode === 'disaster') {
        addLog('ğŸ’¥ å¼€å§‹ç¾éš¾æµ‹è¯•æ¨¡å¼', 'info');
        document.getElementById('disasterControls').style.display = 'block';
        disasterScore = 0;
        document.getElementById('disasterScore').textContent = '0';
    } else if (mode === 'coin') {
        addLog('ğŸ’° å¼€å§‹é‡‘å¸ä¿å­˜æ¸¸æˆ', 'info');
        document.getElementById('coinGame').style.display = 'block';
        coins = 100;
        gameScore = 0;
        document.getElementById('coinCount').textContent = coins;
        document.getElementById('gameScore').textContent = gameScore;
    }
}

// è§¦å‘ç¾éš¾
async function triggerDisaster(type) {
    const disasterNames = {
        'fire': 'ğŸ”¥ ç«ç¾',
        'earthquake': 'ğŸŒ‹ åœ°éœ‡',
        'hacker': 'ğŸ’» é»‘å®¢æ”»å‡»'
    };

    const disasterDescs = {
        'fire': 'é«˜æ¸©æŸåäº†1ä¸ªä¿é™©æŸœï¼',
        'earthquake': 'å¼ºçƒˆéœ‡åŠ¨æŸåäº†2ä¸ªä¿é™©æŸœï¼',
        'hacker': 'æ¶æ„è½¯ä»¶ä¿®æ”¹äº†æ‰€æœ‰ä¿é™©æŸœçš„æ•°æ®ï¼'
    };

    addLog(`ğŸ’¥ ${disasterNames[type]}ç¾éš¾å‘ç”Ÿï¼`, 'disaster');

    // æ˜¾ç¤ºç¾éš¾æ•ˆæœ
    document.getElementById('disasterEffect').style.display = 'block';
    document.getElementById('disasterTitle').textContent = disasterNames[type] + 'å‘ç”Ÿï¼ï¼ï¼';
    document.getElementById('disasterDesc').textContent = disasterDescs[type];
    document.body.classList.add('disaster-flash');

    await sleep(500);

    document.body.classList.remove('disaster-flash');

    // åº”ç”¨ç¾éš¾
    let damagedCount = 0;

    if (type === 'fire') {
        // éšæœºæŸå1ä¸ª
        const targets = ['native', 'redundant', 'dataset'];
        const target = targets[Math.floor(Math.random() * 3)];
        damageSafe(target);
        damagedCount = 1;
    } else if (type === 'earthquake') {
        // éšæœºæŸå2ä¸ª
        const targets = ['native', 'redundant', 'dataset'];
        const shuffled = targets.sort(() => 0.5 - Math.random());
        damageSafe(shuffled[0]);
        damageSafe(shuffled[1]);
        damagedCount = 2;
    } else if (type === 'hacker') {
        // æ¶æ„ä¿®æ”¹æ‰€æœ‰
        nativeData = [0xFF, 0xFF, 0xFF, 0xFF];
        redundantMain = [0xFF, 0xFF, 0xFF, 0xFF];
        redundantBackup = [0xFF, 0xFF, 0xFF, 0xFF];
        datasetVersions = [[0xFF, 0xFF], [0xFF, 0xFF], [0xFF, 0xFF]];
        document.getElementById('nativeSafe').classList.add('damaged');
        document.getElementById('redundantSafe').classList.add('damaged');
        document.getElementById('datasetSafe').classList.add('damaged');
        damagedCount = 3;
    }

    // è®¡ç®—å­˜æ´»
    const nativeAlive = !isDataCorrupted(nativeData);
    const redundantAlive = !isDataCorrupted(redundantMain) || !isDataCorrupted(redundantBackup);
    const datasetAlive = datasetVersions.some(v => !isDataCorrupted(v));

    const survivalCount = [nativeAlive, redundantAlive, datasetAlive].filter(Boolean).length;

    document.getElementById('survivalCount').textContent = `${survivalCount}/3`;

    // æ›´æ–°å¾—åˆ†
    disasterScore += survivalCount * 10;
    document.getElementById('disasterScore').textContent = disasterScore;

    addLog(`ğŸ“Š å­˜æ´»ä¿é™©æŸœ: ${survivalCount}/3, å¾—åˆ†: +${survivalCount * 10}`, 'recovery');

    await sleep(1000);
    document.getElementById('disasterEffect').style.display = 'none';

    // å°è¯•æ¢å¤
    await attemptAllRecoveries();

    updateDisplay();
}

// æŸåä¿é™©æŸœ
function damageSafe(target) {
    if (target === 'native') {
        nativeData = [0xFF, 0xFF, 0xFF, 0xFF];
        document.getElementById('nativeSafe').classList.add('damaged');
        addLog('âŒ Nativeä¿é™©æŸœå·²æŸåï¼', 'disaster');
    } else if (target === 'redundant') {
        if (Math.random() < 0.5) {
            redundantMain = [0xFF, 0xFF, 0xFF, 0xFF];
        } else {
            redundantBackup = [0xFF, 0xFF, 0xFF, 0xFF];
        }
        document.getElementById('redundantSafe').classList.add('damaged');
        addLog('âš ï¸ Redundantä¿é™©æŸœéƒ¨åˆ†æŸåï¼', 'disaster');
    } else if (target === 'dataset') {
        constæŸåç‰ˆæœ¬ = Math.floor(Math.random() * 3);
        datasetVersions[æŸåç‰ˆæœ¬] = [0xFF, 0xFF];
        document.getElementById('datasetSafe').classList.add('damaged');
        addLog('âš ï¸ Datasetä¿é™©æŸœä¸¢å¤±1ä¸ªç‰ˆæœ¬ï¼', 'disaster');
    }
}

// å°è¯•æ‰€æœ‰æ¢å¤
async function attemptAllRecoveries() {
    // Native - æ— æ³•æ¢å¤
    if (isDataCorrupted(nativeData)) {
        addLog('âŒ Native: æ•°æ®æ°¸ä¹…ä¸¢å¤±', 'disaster');
    }

    // Redundant - ä»å¤‡ä»½æ¢å¤
    if (isDataCorrupted(redundantMain) && !isDataCorrupted(redundantBackup)) {
        redundantMain = [...redundantBackup];
        document.getElementById('redundantSafe').classList.remove('damaged');
        document.getElementById('redundantSafe').classList.add('safe');
        addLog('âœ… Redundant: ä»å¤‡ä»½æ¢å¤æˆåŠŸ', 'recovery');
    }

    // Dataset - ä»å†å²ç‰ˆæœ¬æ¢å¤
    const latestGood = datasetVersions.find(v => !isDataCorrupted(v));
    if (latestGood && isDataCorrupted(datasetVersions[0])) {
        datasetVersions[0] = [...latestGood];
        document.getElementById('datasetSafe').classList.remove('damaged');
        document.getElementById('datasetSafe').classList.add('safe');
        addLog('âœ… Dataset: ä»å†å²ç‰ˆæœ¬æ¢å¤æˆåŠŸ', 'recovery');
    }
}

// æ£€æŸ¥æ•°æ®æ˜¯å¦æŸå
function isDataCorrupted(data) {
    return data.some(byte => byte === 0xFF);
}

// é€‰æ‹©ä¿é™©æŸœ
function selectSafe(safe) {
    selectedSafe = safe;
    updateRecommendation();
}

// ä¿å­˜é‡‘å¸
function saveCoins() {
    const dataType = document.getElementById('dataTypeSelect').value;
    const recommendations = {
        'temporary': 'native',
        'important': 'redundant',
        'critical': 'redundant',
        'versioned': 'dataset'
    };

    const optimal = recommendations[dataType];

    if (!selectedSafe) {
        alert('è¯·å…ˆé€‰æ‹©ä¿é™©æŸœï¼');
        return;
    }

    const correct = selectedSafe === optimal;
    let coinChange = 0;

    if (correct) {
        coinChange = 50;
        gameScore += 100;
        addLog(`âœ… æ­£ç¡®ï¼${dataType}ç±»å‹æ•°æ®åº”è¯¥ç”¨${optimal}ä¿é™©æŸœ`, 'coin');
    } else {
        coinChange = -30;
        addLog(`âŒ é”™è¯¯ï¼${dataType}ç±»å‹æ•°æ®åº”è¯¥ç”¨${optimal}ä¿é™©æŸœ`, 'coin');
    }

    coins += coinChange;
    document.getElementById('coinCount').textContent = coins;
    document.getElementById('gameScore').textContent = gameScore;

    // æ˜¾ç¤ºç»“æœ
    const safeNames = {
        'native': 'Nativeä¿é™©æŸœ',
        'redundant': 'Redundantä¿é™©æŸœ',
        'dataset': 'Datasetä¿é™©æŸœ'
    };

    document.getElementById('userChoice').textContent = safeNames[selectedSafe];
    document.getElementById('optimalChoice').textContent = safeNames[optimal];
    document.getElementById('saveResult').innerHTML = correct ?
        '<span class="badge bg-success">âœ… æ­£ç¡®é€‰æ‹©</span>' :
        '<span class="badge bg-danger">âŒ é”™è¯¯é€‰æ‹©</span>';
    document.getElementById('coinResult').innerHTML = coinChange > 0 ?
        `<span class="text-success">+${coinChange} ğŸ’°</span>` :
        `<span class="text-danger">${coinChange} ğŸ’°</span>`;
    document.getElementById('coinResult').style.display = 'block';

    if (coins <= 0) {
        alert('æ¸¸æˆç»“æŸï¼ä½ çš„é‡‘å¸å·²è€—å°½ã€‚');
        resetData();
    }
}

// æ›´æ–°æ¨è
function updateRecommendation() {
    if (currentMode !== 'learning') return;

    const critical = document.getElementById('checkCritical').checked;
    const version = document.getElementById('checkVersion').checked;
    const frequent = document.getElementById('checkFrequent').checked;

    let recommendation = '';
    let reason = '';

    if (version) {
        recommendation = 'â­ Dataset Block';
        reason = 'éœ€è¦å†å²ç‰ˆæœ¬ç®¡ç†';
    } else if (critical) {
        recommendation = 'âœ… Redundant Block';
        reason = 'å…³é”®æ•°æ®éœ€è¦å¤‡ä»½';
    } else if (frequent) {
        recommendation = 'âŒ Native Block';
        reason = 'é¢‘ç¹ä¿®æ”¹ä¸”éå…³é”®æ•°æ®';
    } else {
        recommendation = 'âŒ Native Block';
        reason = 'éå…³é”®æ•°æ®ï¼ŒèŠ‚çœå­˜å‚¨';
    }

    document.getElementById('recommendationResult').innerHTML = `
        <h6>æ¨èé€‰æ‹©: ${recommendation}</h6>
        <p class="mb-0"><strong>ç†ç”±:</strong> ${reason}</p>
    `;
}

// æ›´æ–°æ˜¾ç¤º
function updateDisplay() {
    // Native
    updateDataDisplay('nativeData', nativeData, 'Native');

    // Redundant
    const redundantDisplay = !isDataCorrupted(redundantMain) ? redundantMain :
        !isDataCorrupted(redundantBackup) ? redundantBackup :
        [0xFF, 0xFF, 0xFF, 0xFF];
    updateDataDisplay('redundantData', redundantDisplay, 'Redundant');

    // Dataset
    const latestDataset = datasetVersions[0];
    updateDataDisplay('datasetData', latestDataset, `Dataset (ç‰ˆæœ¬${datasetVersions.length})`);
}

// æ›´æ–°æ•°æ®æ˜¾ç¤º
function updateDataDisplay(elementId, data, label) {
    const element = document.getElementById(elementId);
    if (data.length === 0) {
        element.innerHTML = '<p class="text-muted">æ— æ•°æ®</p>';
        return;
    }

    const corrupted = isDataCorrupted(data);
    const dataStr = data.map(b => '0x' + b.toString(16).toUpperCase()).join(' ');

    element.innerHTML = `
        <strong>${label}:</strong><br>
        <code class="${corrupted ? 'text-danger' : 'text-success'}">${dataStr}</code><br>
        ${corrupted ? '<small class="text-danger">âš ï¸ æ•°æ®å·²æŸå</small>' : '<small class="text-success">âœ… æ•°æ®å®Œæ•´</small>'}
    `;
}

// æ·»åŠ æ—¥å¿—
function addLog(message, type = 'info') {
    const log = document.getElementById('eventLog');
    const entry = document.createElement('div');
    entry.className = `log-entry log-${type}`;
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

    if (log.querySelector('.text-muted')) {
        log.innerHTML = '';
    }

    log.insertBefore(entry, log.firstChild);

    // é™åˆ¶æ—¥å¿—æ•°é‡
    while (log.children.length > 50) {
        log.removeChild(log.lastChild);
    }
}

// è¾…åŠ©å‡½æ•°
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// é¡µé¢åŠ è½½åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    init();
});
</script>
{% endblock %}
