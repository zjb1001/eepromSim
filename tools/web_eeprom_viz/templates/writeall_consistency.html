{% extends "base.html" %}

{% block title %}WriteAllä¸€è‡´æ€§ - EEPROMå¯è§†åŒ–{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">ğŸ” WriteAllä¸€è‡´æ€§ä¸æ‰ç”µæ¢å¤</h2>

    <div class="alert alert-info">
        <strong>ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ:</strong> WriteAllä½¿ç”¨ä¸¤é˜¶æ®µæäº¤ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚
        <strong>Phase 1</strong>: åˆ›å»ºå¿«ç…§å¹¶æŒä¹…åŒ– â†’ <strong>Phase 2</strong>: å¤åˆ¶åˆ°ç›®æ ‡ä½ç½®å¹¶æ ¡éªŒã€‚
        å³ä½¿æ‰ç”µä¹Ÿèƒ½æ¢å¤åˆ°ä¸€è‡´æ€§çŠ¶æ€ã€‚
    </div>

    <!-- å½“å‰çŠ¶æ€ -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“ å½“å‰çŠ¶æ€</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h4 id="currentPhase">IDLE</h4>
                            <small>å½“å‰é˜¶æ®µ</small>
                        </div>
                        <div class="col-md-3">
                            <h4 id="virtualTime">0</h4>
                            <small>è™šæ‹Ÿæ—¶é—´</small>
                        </div>
                        <div class="col-md-3">
                            <h4 id="snapshotStatus">âŒ</h4>
                            <small>å¿«ç…§å¯ç”¨</small>
                        </div>
                        <div class="col-md-3">
                            <h4 id="dirtyDataStatus">âœ…</h4>
                            <small>æ•°æ®ä¸€è‡´</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸¤é˜¶æ®µæäº¤å¯è§†åŒ– -->
    <div class="row mb-3">
        <div class="col-md-6">
            <!-- Phase 1 -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Phase 1: å¿«ç…§åˆ›å»º</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div id="phase1Status" class="alert alert-secondary">
                            ç­‰å¾…å¼€å§‹...
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Block ID:</label>
                        <select id="blockIdSelect" class="form-select">
                            <option value="0">Block 0 (Native)</option>
                            <option value="1">Block 1 (Redundant)</option>
                            <option value="2">Block 2 (Dataset)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ–°æ•°æ® (Hex):</label>
                        <input type="text" id="newDataInput" class="form-control"
                               value="AA" placeholder="ä¾‹å¦‚: AA" maxlength="32">
                        <small class="text-muted">è¾“å…¥åå…­è¿›åˆ¶æ•°æ®ï¼Œä¾‹å¦‚: AA è¡¨ç¤º 0xAA</small>
                    </div>

                    <button class="btn btn-primary w-100 mb-2" onclick="executePhase1()">
                        ğŸš€ æ‰§è¡ŒPhase 1
                    </button>

                    <!-- å¿«ç…§æ•°æ®å±•ç¤º -->
                    <div id="snapshotDisplay" class="mt-3" style="display:none;">
                        <h6>ğŸ“¸ å¿«ç…§æ•°æ®:</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <p class="mb-1"><strong>Data:</strong> <code id="snapshotData"></code></p>
                                <p class="mb-1"><strong>CRC16:</strong> <code id="snapshotCrc"></code></p>
                                <p class="mb-0"><strong>Timestamp:</strong> <span id="snapshotTimestamp"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <!-- Phase 2 -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Phase 2: æ•°æ®å¤åˆ¶</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div id="phase2Status" class="alert alert-secondary">
                            ç­‰å¾…Phase 1å®Œæˆ...
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" id="dirtyDataCheck" class="form-check-input">
                            <label class="form-check-label" for="dirtyDataCheck">
                                æ³¨å…¥è„æ•°æ®ï¼ˆæ¨¡æ‹Ÿå¿«ç…§åRAMè¢«ä¿®æ”¹ï¼‰
                            </label>
                        </div>
                    </div>

                    <button class="btn btn-success w-100 mb-2" onclick="executePhase2()" id="phase2Btn" disabled>
                        ğŸ“ æ‰§è¡ŒPhase 2
                    </button>

                    <!-- æœ€ç»ˆæ•°æ®å±•ç¤º -->
                    <div id="finalDataDisplay" class="mt-3" style="display:none;">
                        <h6>âœ… æœ€ç»ˆæ•°æ®:</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <p class="mb-1"><strong>CRC16:</strong> <code id="finalCrc"></code></p>
                                <p class="mb-0"><strong>æ ¡éªŒç»“æœ:</strong> <span id="verifyResult"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰ç”µæ¢å¤å®éªŒ -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-warning">
                    <h5>âš¡ æ‰ç”µæ¢å¤å®éªŒ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <p class="text-muted">
                                æ¨¡æ‹Ÿåœ¨ä¸åŒé˜¶æ®µæ‰ç”µï¼Œè§‚å¯ŸNvMå¦‚ä½•æ¢å¤æ•°æ®ä¸€è‡´æ€§ã€‚
                            </p>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-danger" onclick="simulatePowerLoss('before_phase1')">
                                    Phase 1ä¹‹å‰
                                </button>
                                <button class="btn btn-outline-warning" onclick="simulatePowerLoss('after_phase1')">
                                    Phase 1ä¹‹å
                                </button>
                                <button class="btn btn-outline-danger" onclick="simulatePowerLoss('during_phase2')">
                                    Phase 2æœŸé—´
                                </button>
                                <button class="btn btn-outline-success" onclick="simulatePowerLoss('after_phase2')">
                                    Phase 2ä¹‹å
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" onclick="resetSimulation()">
                                ğŸ”„ é‡ç½®å®éªŒ
                            </button>
                        </div>
                    </div>

                    <!-- æ¢å¤ç»“æœ -->
                    <div id="recoveryResult" class="mt-3" style="display:none;">
                        <div class="alert alert-info">
                            <h6>ğŸ”§ æ¢å¤ç»“æœ:</h6>
                            <p class="mb-1"><strong>æ‰ç”µç‚¹:</strong> <span id="powerLossPoint"></span></p>
                            <p class="mb-1"><strong>æ¢å¤ç­–ç•¥:</strong> <span id="recoveryStrategy"></span></p>
                            <p class="mb-0"><strong>æœ€ç»ˆçŠ¶æ€:</strong> <span id="finalState"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- äº‹ä»¶æ—¥å¿— -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“‹ äº‹ä»¶æ—¥å¿—</h5>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <div id="eventLog">
                        <p class="text-muted text-center">æš‚æ— äº‹ä»¶</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentBlockId = 0;
let currentNewData = 'AA';

// æ‰§è¡ŒPhase 1
async function executePhase1() {
    currentBlockId = parseInt(document.getElementById('blockIdSelect').value);
    const inputHex = document.getElementById('newDataInput').value.trim();
    currentNewData = inputHex || 'AA';

    try {
        // Step 1: Start
        const startResponse = await fetch('/api/writeall/start', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                block_id: currentBlockId,
                new_data: currentNewData
            })
        });
        const startResult = await startResponse.json();

        // Step 2: Snapshot
        const snapshotResponse = await fetch('/api/writeall/phase1_snapshot', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({block_id: currentBlockId})
        });
        const snapshotResult = await snapshotResponse.json();

        // Step 3: Persist
        const persistResponse = await fetch('/api/writeall/phase1_persist', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({block_id: currentBlockId})
        });
        const persistResult = await persistResponse.json();

        // Update display
        document.getElementById('phase1Status').className = 'alert alert-success';
        document.getElementById('phase1Status').innerHTML = 'âœ… Phase 1 å®Œæˆ: å¿«ç…§å·²åˆ›å»ºå¹¶æŒä¹…åŒ–';

        document.getElementById('snapshotDisplay').style.display = 'block';
        document.getElementById('snapshotData').textContent = snapshotResult.snapshot.data;
        document.getElementById('snapshotCrc').textContent = snapshotResult.snapshot.checksum;
        document.getElementById('snapshotTimestamp').textContent = snapshotResult.snapshot.timestamp;

        document.getElementById('phase2Btn').disabled = false;

        await updateStatus();

    } catch (error) {
        console.error('Error:', error);
        alert('Phase 1 æ‰§è¡Œå¤±è´¥: ' + error);
    }
}

// æ‰§è¡ŒPhase 2
async function executePhase2() {
    const injectDirty = document.getElementById('dirtyDataCheck').checked;

    try {
        // Step 1: Copy new data
        const copyResponse = await fetch('/api/writeall/phase2_copy', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                block_id: currentBlockId,
                new_data: currentNewData,
                inject_dirty: injectDirty
            })
        });
        const copyResult = await copyResponse.json();

        if (copyResult.dirty_data_detected) {
            document.getElementById('phase2Status').className = 'alert alert-danger';
            document.getElementById('phase2Status').innerHTML = 'âŒ è„æ•°æ®æ£€æµ‹: RAMæ•°æ®åœ¨å¿«ç…§åè¢«ä¿®æ”¹';
            await updateStatus();
            return;
        }

        // Step 2: Verify
        const verifyResponse = await fetch('/api/writeall/phase2_verify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({block_id: currentBlockId})
        });
        const verifyResult = await verifyResponse.json();

        // Update display
        if (verifyResult.is_valid) {
            document.getElementById('phase2Status').className = 'alert alert-success';
            document.getElementById('phase2Status').innerHTML = 'âœ… Phase 2 å®Œæˆ: æ•°æ®å·²å¤åˆ¶å¹¶é€šè¿‡æ ¡éªŒ';
        } else {
            document.getElementById('phase2Status').className = 'alert alert-warning';
            document.getElementById('phase2Status').innerHTML = 'âš ï¸ Phase 2 å®Œæˆ: ä½†æ ¡éªŒå¤±è´¥';
        }

        document.getElementById('finalDataDisplay').style.display = 'block';
        document.getElementById('finalCrc').textContent = verifyResult.checksum;
        document.getElementById('verifyResult').innerHTML = verifyResult.is_valid ?
            '<span class="text-success">âœ… æ ¡éªŒé€šè¿‡</span>' :
            '<span class="text-danger">âŒ æ ¡éªŒå¤±è´¥</span>';

        await updateStatus();

    } catch (error) {
        console.error('Error:', error);
        alert('Phase 2 æ‰§è¡Œå¤±è´¥: ' + error);
    }
}

// æ¨¡æ‹Ÿæ‰ç”µæ¢å¤
async function simulatePowerLoss(recoveryPoint) {
    try {
        const response = await fetch('/api/writeall/power_loss', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({recovery_point: recoveryPoint})
        });

        const result = await response.json();

        document.getElementById('recoveryResult').style.display = 'block';
        document.getElementById('powerLossPoint').textContent = result.power_loss_point;
        document.getElementById('recoveryStrategy').textContent = result.recovery_result;
        document.getElementById('finalState').innerHTML =
            `<span class="badge bg-${result.current_phase === 'COMPLETED' ? 'success' : 'warning'}">${result.current_phase}</span>`;

        await updateStatus();

    } catch (error) {
        console.error('Error:', error);
        alert('æ‰ç”µæ¨¡æ‹Ÿå¤±è´¥: ' + error);
    }
}

// é‡ç½®ä»¿çœŸ
async function resetSimulation() {
    try {
        await fetch('/api/writeall/reset', {method: 'POST'});

        document.getElementById('phase1Status').className = 'alert alert-secondary';
        document.getElementById('phase1Status').innerHTML = 'ç­‰å¾…å¼€å§‹...';
        document.getElementById('phase2Status').className = 'alert alert-secondary';
        document.getElementById('phase2Status').innerHTML = 'ç­‰å¾…Phase 1å®Œæˆ...';

        document.getElementById('snapshotDisplay').style.display = 'none';
        document.getElementById('finalDataDisplay').style.display = 'none';
        document.getElementById('recoveryResult').style.display = 'none';

        document.getElementById('phase2Btn').disabled = true;

        await updateStatus();

    } catch (error) {
        console.error('Error:', error);
    }
}

// æ›´æ–°çŠ¶æ€
async function updateStatus() {
    try {
        const response = await fetch('/api/writeall/status');
        const status = await response.json();

        document.getElementById('currentPhase').textContent = status.current_phase;
        document.getElementById('virtualTime').textContent = status.virtual_time;
        document.getElementById('snapshotStatus').textContent = status.snapshot_available ? 'âœ…' : 'âŒ';
        document.getElementById('dirtyDataStatus').textContent = status.dirty_data_detected ? 'âš ï¸' : 'âœ…';

        // Update event log
        const logDiv = document.getElementById('eventLog');
        if (status.event_log && status.event_log.length > 0) {
            logDiv.innerHTML = status.event_log.map(log =>
                `<p class="mb-1"><small>[${log.time}] ${log.event}</small></p>`
            ).reverse().join('');
        } else {
            logDiv.innerHTML = '<p class="text-muted text-center">æš‚æ— äº‹ä»¶</p>';
        }

    } catch (error) {
        console.error('Error:', error);
    }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    updateStatus();
});
</script>
{% endblock %}
