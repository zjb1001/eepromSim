{% extends "base.html" %}

{% block title %}ç£¨æŸå‡è¡¡ - EEPROMå¯è§†åŒ–{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4">ğŸ”„ ç£¨æŸåˆ†æ</h2>

    <div class="alert alert-warning">
        <strong>âš ï¸ é—®é¢˜:</strong> å¦‚æœæ€»æ˜¯å†™å…¥åŒä¸€ä¸ªPageï¼Œå®ƒä¼šå¿«é€Ÿç£¨æŸå¤±æ•ˆã€‚
        <strong>ğŸ’¡ è§£å†³æ–¹æ¡ˆ:</strong> ä½¿ç”¨ç£¨æŸå‡è¡¡ç®—æ³•ï¼Œå‡åŒ€åˆ†é…æ“¦å†™æ¬¡æ•°åˆ°æ‰€æœ‰Pageã€‚
    </div>

    <!-- å½“å‰ç£¨æŸçŠ¶æ€ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span>ğŸ“Š å½“å‰å„Pageç£¨æŸæƒ…å†µï¼ˆçƒ­åŠ›å›¾ï¼‰</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshStats()">
                        ğŸ”„ åˆ·æ–°
                    </button>
                </div>
                <div class="card-body">
                    <div class="row" id="wearGrid">
                        <!-- Pageå¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç£¨æŸç»Ÿè®¡ -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“ˆ ç£¨æŸç»Ÿè®¡</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h3 id="avgErases">0</h3>
                            <small>å¹³å‡æ“¦å†™æ¬¡æ•°</small>
                        </div>
                        <div class="col-md-3">
                            <h3 id="maxErases">0</h3>
                            <small>æœ€å¤§æ“¦å†™æ¬¡æ•°</small>
                        </div>
                        <div class="col-md-3">
                            <h3 id="minErases">0</h3>
                            <small>æœ€å°æ“¦å†™æ¬¡æ•°</small>
                        </div>
                        <div class="col-md-3">
                            <h3 id="imbalanceRatio">0x</h3>
                            <small>ä¸å‡åŒ€åº¦</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç­–ç•¥å¯¹æ¯”å®éªŒ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ§ª ç£¨æŸå‡è¡¡ç­–ç•¥å¯¹æ¯”å®éªŒ</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©ç­–ç•¥:</label>
                        <select id="strategySelect" class="form-select">
                            <option value="none">âŒ æ— ç£¨æŸå‡è¡¡ï¼ˆæ€»æ˜¯å†™Page 0ï¼‰</option>
                            <option value="round_robin">âœ… ç®€å•è½®è¯¢å‡è¡¡</option>
                            <option value="dynamic">â­ åŠ¨æ€ç£¨æŸå‡è¡¡</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ¨¡æ‹Ÿå†™å…¥æ¬¡æ•°:</label>
                        <input type="number" id="numWritesInput" class="form-control" value="100" min="10" max="1000">
                    </div>

                    <button id="simulateBtn" class="btn btn-primary w-100">
                        ğŸš€ å¼€å§‹æ¨¡æ‹Ÿ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ‹Ÿç»“æœ -->
    <div class="row mt-4" id="resultSection" style="display:none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“Š æ¨¡æ‹Ÿç»“æœ</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="alert alert-info mb-0">
                                <strong>ç­–ç•¥:</strong> <span id="resultStrategy">-</span><br>
                                <strong>å†™å…¥æ¬¡æ•°:</strong> <span id="resultNumWrites">-</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-warning mb-0">
                                <strong>å¹³å‡æ“¦å†™:</strong> <span id="resultAvg">-</span><br>
                                <strong>æœ€å¤§æ“¦å†™:</strong> <span id="resultMax">-</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-danger mb-0">
                                <strong>ä¸å‡åŒ€åº¦:</strong> <span id="resultImbalance">-</span><br>
                                <small class="text-muted">è¶Šå°è¶Šå‡è¡¡</small>
                            </div>
                        </div>
                    </div>

                    <canvas id="wearChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let wearChart;

// åˆ·æ–°ç£¨æŸç»Ÿè®¡
async function refreshStats() {
    try {
        const response = await fetch('/api/wear_stats');
        const stats = await response.json();

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        document.getElementById('avgErases').textContent = stats.average;
        document.getElementById('maxErases').textContent = stats.max;
        document.getElementById('minErases').textContent = stats.min;
        document.getElementById('imbalanceRatio').textContent = `${stats.imbalance_ratio}x`;

        // æ›´æ–°Pageç½‘æ ¼
        const gridHtml = stats.pages.map(page => {
            const lifePercent = page.life_percent;
            const bgColor = lifePercent > 50 ? '#d4edda' : lifePercent > 20 ? '#fff3cd' : '#f8d7da';

            return `
                <div class="col-md-3 mb-3">
                    <div class="card" style="background-color: ${bgColor}">
                        <div class="card-body p-2 text-center">
                            <h6>Page #${page.id}</h6>
                            <div class="progress mb-2">
                                <div class="progress-bar" style="width: ${lifePercent}%"></div>
                            </div>
                            <small>æ“¦å†™: ${page.erase_count}æ¬¡<br>å¯¿å‘½: ${lifePercent}%</small>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        document.getElementById('wearGrid').innerHTML = gridHtml;

    } catch (error) {
        console.error('Error:', error);
    }
}

// æ¨¡æ‹Ÿç£¨æŸ
document.getElementById('simulateBtn').addEventListener('click', async function() {
    const strategy = document.getElementById('strategySelect').value;
    const numWrites = parseInt(document.getElementById('numWritesInput').value);

    try {
        const response = await fetch('/api/simulate_writes', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                num_writes: numWrites,
                strategy: strategy
            })
        });

        const result = await response.json();

        // æ˜¾ç¤ºç»“æœ
        document.getElementById('resultSection').style.display = 'block';
        document.getElementById('resultStrategy').textContent = result.strategy;
        document.getElementById('resultNumWrites').textContent = result.num_writes;
        document.getElementById('resultAvg').textContent = result.average;
        document.getElementById('resultMax').textContent = result.max;
        document.getElementById('resultImbalance').textContent = `${result.imbalance_ratio}x`;

        // æ›´æ–°å›¾è¡¨
        updateChart(result);

    } catch (error) {
        console.error('Error:', error);
        alert('æ¨¡æ‹Ÿå¤±è´¥: ' + error);
    }
});

// æ›´æ–°å›¾è¡¨
function updateChart(result) {
    const ctx = document.getElementById('wearChart').getContext('2d');

    if (wearChart) {
        wearChart.destroy();
    }

    const pageLabels = result.final_counts.map((_, i) => `Page ${i}`);
    const strategyNames = {
        'none': 'æ— ç£¨æŸå‡è¡¡',
        'round_robin': 'è½®è¯¢å‡è¡¡',
        'dynamic': 'åŠ¨æ€å‡è¡¡'
    };

    wearChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: pageLabels,
            datasets: [{
                label: `${strategyNames[result.strategy]} - æ“¦å†™æ¬¡æ•°`,
                data: result.final_counts,
                backgroundColor: result.strategy === 'none' ?
                    'rgba(255, 99, 132, 0.5)' : 'rgba(75, 192, 192, 0.5)',
                borderColor: result.strategy === 'none' ?
                    'rgba(255, 99, 132, 1)' : 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'æ“¦å†™æ¬¡æ•°'
                    }
                }
            },
            plugins: {
                annotation: {
                    annotations: {
                        line1: {
                            type: 'line',
                            yMin: result.average,
                            yMax: result.average,
                            borderColor: 'rgb(255, 99, 132)',
                            borderWidth: 2,
                            borderDash: [5, 5]
                        }
                    }
                }
            }
        }
    });
}

// é¡µé¢åŠ è½½æ—¶åˆ·æ–°ç»Ÿè®¡
document.addEventListener('DOMContentLoaded', function() {
    refreshStats();
});
</script>
{% endblock %}
