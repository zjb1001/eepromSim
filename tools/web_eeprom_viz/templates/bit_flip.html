{% extends "base.html" %}

{% block title %}ä½ç¿»è½¬æ•…éšœ - EEPROMå¯è§†åŒ–{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4">âš ï¸ å®éªŒ: ä½ç¿»è½¬æ•…éšœ</h2>

    <div class="alert alert-warning">
        <strong>ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ:</strong> EEPROMå› å¹²æ‰°æˆ–è€åŒ–å¯èƒ½å¯¼è‡´æ•°æ®ä½éšæœºç¿»è½¬ã€‚
        CRCæ ¡éªŒå¯ä»¥æ£€æµ‹åˆ°è¿™ç§æ•°æ®æŸåã€‚
    </div>

    <!-- æ•…éšœæ³¨å…¥æ§åˆ¶ -->
    <div class="row mb-4">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ§ª æ³¨å…¥ä½ç¿»è½¬æ•…éšœ</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">æ•°æ®åœ°å€:</label>
                        <input type="number" id="addressInput" class="form-control" value="0" min="0" max="4096">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ•°æ®é•¿åº¦ (å­—èŠ‚):</label>
                        <input type="number" id="lengthInput" class="form-control" value="4" min="1" max="32">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ç¿»è½¬ä½æ•°:</label>
                        <select id="numBitsSelect" class="form-select">
                            <option value="1">1 bit (å•bitç¿»è½¬)</option>
                            <option value="2">2 bits (åŒbitç¿»è½¬)</option>
                            <option value="3">3 bits (å¤šbitç¿»è½¬)</option>
                        </select>
                    </div>

                    <button id="injectBtn" class="btn btn-danger w-100">
                        ğŸ’¥ æ³¨å…¥ä½ç¿»è½¬
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»“æœå±•ç¤º -->
    <div class="row" id="resultSection" style="display:none;">
        <!-- åŸå§‹æ•°æ® -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">âœ… åŸå§‹æ•°æ®</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>åœ°å€:</strong> <span id="originalAddress">0x0000</span>
                    </div>
                    <div class="mb-3">
                        <strong>æ•°æ®:</strong>
                        <div class="hex-display bg-light p-2" id="originalData">FF FF FF FF</div>
                    </div>
                    <div class="mb-3">
                        <strong>CRC16:</strong>
                        <code id="originalCrc">0x4A3F</code>
                    </div>
                    <div id="originalBinary" class="mt-3">
                        <!-- äºŒè¿›åˆ¶æ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¿»è½¬åæ•°æ® -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">âŒ ç¿»è½¬åæ•°æ®</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>ç¿»è½¬ä½ç½®:</strong>
                        <div id="flipPositions"></div>
                    </div>
                    <div class="mb-3">
                        <strong>æ•°æ®:</strong>
                        <div class="hex-display bg-light p-2" id="flippedData">FF FF FF FF</div>
                    </div>
                    <div class="mb-3">
                        <strong>CRC16:</strong>
                        <code id="flippedCrc">0x4A3F</code>
                    </div>
                    <div id="flippedBinary" class="mt-3">
                        <!-- äºŒè¿›åˆ¶æ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CRCæ£€æµ‹ç»“æœ -->
    <div class="row mt-4" id="crcResultSection" style="display:none;">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <h3 id="crcResultTitle">âœ“ CRCæ ¡éªŒ</h3>
                    <p id="crcResultMessage" class="lead"></p>
                    <div id="crcResultExplanation"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŸç†è¯´æ˜ -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦CRCæ ¡éªŒï¼Ÿ</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>ä½ç¿»è½¬åŸå› :</h6>
                            <ul>
                                <li>âš¡ ç”µç£å¹²æ‰°</li>
                                <li>ğŸŒ¡ï¸ æ¸©åº¦å˜åŒ–</li>
                                <li>â³ è€åŒ–æ•ˆåº”</li>
                                <li>ğŸ’¥ è¾å°„</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>CRCæ ¡éªŒä½œç”¨:</h6>
                            <ul>
                                <li>âœ… æ£€æµ‹æ•°æ®æŸå</li>
                                <li>âœ… ä¿è¯æ•°æ®å®Œæ•´æ€§</li>
                                <li>âœ… é˜²æ­¢ä½¿ç”¨é”™è¯¯æ•°æ®</li>
                                <li>âœ… è§¦å‘æ¢å¤æœºåˆ¶</li>
                            </ul>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3">
                        <strong>ğŸ“Œ å®é™…åº”ç”¨:</strong> NvMæ¨¡å—åœ¨æ¯æ¬¡è¯»å–Blockåéƒ½ä¼šè¿›è¡ŒCRCæ ¡éªŒã€‚
                        å¦‚æœæ ¡éªŒå¤±è´¥ï¼Œä¼šå°è¯•ä»å¤‡ä»½å‰¯æœ¬æ¢å¤ï¼ˆRedundant Blockï¼‰æˆ–è¿”å›é»˜è®¤å€¼ï¼ˆNative Blockï¼‰ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// æ³¨å…¥ä½ç¿»è½¬
document.getElementById('injectBtn').addEventListener('click', async function() {
    const address = parseInt(document.getElementById('addressInput').value);
    const length = parseInt(document.getElementById('lengthInput').value);
    const numBits = parseInt(document.getElementById('numBitsSelect').value);

    try {
        const response = await fetch('/api/inject_bit_flip', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                address: address,
                length: length,
                num_bits: numBits
            })
        });

        const result = await response.json();

        // æ˜¾ç¤ºç»“æœåŒºåŸŸ
        document.getElementById('resultSection').style.display = 'block';
        document.getElementById('crcResultSection').style.display = 'block';

        // æ›´æ–°åŸå§‹æ•°æ®
        document.getElementById('originalAddress').textContent = result.address;
        document.getElementById('originalData').textContent = formatHex(result.original_data);
        document.getElementById('originalCrc').textContent = result.original_crc;

        // æ˜¾ç¤ºåŸå§‹æ•°æ®çš„äºŒè¿›åˆ¶
        const origBytes = result.original_data.match(/.{2}/g) || [];
        document.getElementById('originalBinary').innerHTML = origBytes.map((byte, i) => `
            <div class="mb-1">
                <small>Offset 0x${i.toString(16).padStart(2,'0').toUpperCase()}:</small><br>
                <code>${hexToBinary(byte)}</code>
            </div>
        `).join('');

        // æ›´æ–°ç¿»è½¬åæ•°æ®
        document.getElementById('flippedData').textContent = formatHex(result.flipped_data);
        document.getElementById('flippedCrc').textContent = result.flipped_crc;

        // æ˜¾ç¤ºç¿»è½¬ä½ç½®
        const flipPositionsHtml = result.flip_positions.map(pos => `
            <div class="alert alert-danger mb-2">
                <strong>ä½ç½®:</strong> Offset 0x${pos.offset.toString(16).padStart(2,'0').toUpperCase()},
                Bit ${pos.bit}<br>
                <code>${pos.original_binary}</code> â†’ <code>${pos.flipped_binary}</code><br>
                ${pos.original} â†’ ${pos.flipped}
            </div>
        `).join('');
        document.getElementById('flipPositions').innerHTML = flipPositionsHtml;

        // æ˜¾ç¤ºç¿»è½¬åæ•°æ®çš„äºŒè¿›åˆ¶ï¼ˆé«˜äº®ç¿»è½¬çš„ä½ï¼‰
        const flipBytes = result.flipped_data.match(/.{2}/g) || [];
        document.getElementById('flippedBinary').innerHTML = flipBytes.map((byte, i) => {
            const flipPos = result.flip_positions.find(p => p.offset === i);
            if (flipPos) {
                const binaryStr = hexToBinary(byte);
                const highlighted = binaryStr.split('').map((bit, idx) => {
                    return idx === 7 - flipPos.bit ? `<strong style="color:red;font-size:1.2em">${bit}</strong>` : bit;
                }).join('');
                return `
                    <div class="mb-1">
                        <small>Offset 0x${i.toString(16).padStart(2,'0').toUpperCase()}:</small><br>
                        <code>${highlighted}</code> â¬…ï¸ Bit ${flipPos.bit}ç¿»è½¬
                    </div>
                `;
            }
            return '';
        }).join('');

        // CRCæ£€æµ‹ç»“æœ
        const crcResultTitle = document.getElementById('crcResultTitle');
        const crcResultMessage = document.getElementById('crcResultMessage');
        const crcResultExplanation = document.getElementById('crcResultExplanation');

        if (result.crc_mismatch) {
            crcResultTitle.innerHTML = 'âŒ CRCä¸åŒ¹é…ï¼æ•°æ®æŸåè¢«æ£€æµ‹åˆ°';
            crcResultTitle.className = 'text-danger';
            crcResultMessage.innerHTML = `åŸå§‹CRC: ${result.original_crc}<br>ç¿»è½¬åCRC: ${result.flipped_crc}`;
            crcResultExplanation.innerHTML = `
                <div class="alert alert-danger">
                    <strong>âœ“ æ•…éšœæ£€æµ‹æˆåŠŸï¼</strong><br>
                    ç”±äºCRCæ ¡éªŒå¤±è´¥ï¼ŒNvMä¸ä¼šä½¿ç”¨æŸåçš„æ•°æ®ã€‚<br>
                    <strong>æ¢å¤ç­–ç•¥:</strong>
                    <ul class="mb-0 mt-2">
                        <li><strong>Native Block:</strong> è¿”å›ROMé»˜è®¤å€¼</li>
                        <li><strong>Redundant Block:</strong> å°è¯•ä»å¤‡ä»½å‰¯æœ¬è¯»å–</li>
                        <li><strong>Dataset Block:</strong> å°è¯•å…¶ä»–ç‰ˆæœ¬çš„æ•°æ®</li>
                    </ul>
                </div>
            `;
        } else {
            crcResultTitle.innerHTML = 'âœ“ CRCåŒ¹é…ï¼ˆæ­¤åœºæ™¯æœªæ£€æµ‹åˆ°æŸåï¼‰';
            crcResultTitle.className = 'text-success';
            crcResultMessage.innerHTML = `CRC: ${result.original_crc}`;
            crcResultExplanation.innerHTML = `
                <div class="alert alert-warning">
                    <strong>âš ï¸ æ³¨æ„:</strong> è™½ç„¶æ³¨å…¥äº†ä½ç¿»è½¬ï¼Œä½†CRCç¢°å·§åŒ¹é…ï¼ˆæ¦‚ç‡å¾ˆä½ï¼‰<br>
                    åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒCRC16èƒ½æ£€æµ‹åˆ°99.998%ä»¥ä¸Šçš„å•bité”™è¯¯å’Œ99.99%ä»¥ä¸Šçš„åŒbité”™è¯¯ã€‚
                </div>
            `;
        }

    } catch (error) {
        console.error('Error:', error);
        alert('æ³¨å…¥å¤±è´¥: ' + error);
    }
});

// è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–åå…­è¿›åˆ¶
function formatHex(hexStr) {
    const bytes = hexStr.match(/.{2}/g) || [];
    return bytes.join(' ');
}

// è¾…åŠ©å‡½æ•°ï¼šåå…­è¿›åˆ¶è½¬äºŒè¿›åˆ¶
function hexToBinary(hex) {
    const val = parseInt(hex, 16);
    return val.toString(2).padStart(8, '0');
}
</script>
{% endblock %}
