{% extends "base.html" %}

{% block title %}æ“¦é™¤-å†™å…¥ä¾èµ– - EEPROMå¯è§†åŒ–{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4">ğŸ”¬ å®éªŒ: æ“¦é™¤-å†™å…¥ä¾èµ–å…³ç³»</h2>

    <div class="row">
        <!-- åœºæ™¯1: æœªæ“¦é™¤ç›´æ¥å†™å…¥ -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>âŒ åœºæ™¯1: æœªæ“¦é™¤ç›´æ¥å†™å…¥ï¼ˆä¼šå¤±è´¥ï¼‰</h4>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©Page:</label>
                        <select id="pageSelect" class="form-select">
                            {% for page in pages %}
                            <option value="{{ page.page_id }}">
                                Page #{{ page.page_id }} ({{ page.state }}, æ“¦å†™{{ page.erase_count }}æ¬¡)
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">åç§»åœ°å€:</label>
                        <input type="number" id="offsetInput" class="form-control" value="0" min="0" max="255">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">å†™å…¥æ•°æ® (HEX):</label>
                        <input type="text" id="dataInput" class="form-control" value="55" maxlength="64">
                        <div class="form-text">ä¾‹å¦‚: 55 è¡¨ç¤ºå†™å…¥ 0x55</div>
                    </div>

                    <button id="checkWriteBtn" class="btn btn-primary w-100">
                        ğŸ” æ£€æŸ¥æ˜¯å¦å¯ä»¥å†™å…¥
                    </button>

                    <div id="resultCard" class="card mt-3 result-card" style="display:none">
                        <div class="card-header">æ£€æŸ¥ç»“æœ</div>
                        <div class="card-body" id="resultContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åœºæ™¯2: å…ˆæ“¦é™¤å†å†™å…¥ -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>âœ… åœºæ™¯2: å…ˆæ“¦é™¤å†å†™å…¥ï¼ˆä¼šæˆåŠŸï¼‰</h4>
                </div>
                <div class="card-body">
                    <p class="text-muted">ä½¿ç”¨å·¦ä¾§é€‰æ‹©çš„Pageå’Œæ•°æ®</p>

                    <p class="fw-bold">æ­¥éª¤1: å…ˆæ“¦é™¤Page</p>
                    <button id="eraseBtn" class="btn btn-danger btn-lg w-100 mb-3">
                        ğŸ—‘ï¸ æ“¦é™¤Page #<span id="erasePageId">0</span>
                    </button>

                    <p class="fw-bold">æ­¥éª¤2: å†å†™å…¥æ•°æ®</p>
                    <button id="writeAfterEraseBtn" class="btn btn-success btn-lg w-100" disabled>
                        âœï¸ å†™å…¥æ•°æ®
                    </button>

                    <div id="successResult" class="alert alert-success mt-3" style="display:none">
                        <strong>âœ“ å†™å…¥æˆåŠŸï¼</strong>
                        <div id="successContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŸç†è¯´æ˜ -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4>ğŸ’¡ ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ</h4>
                </div>
                <div class="card-body">
                    <h5>EEPROMçš„ç‰©ç†æœºåˆ¶:</h5>
                    <ul>
                        <li>æ¯ä¸ªå­˜å‚¨å•å…ƒå¯ä»¥çœ‹ä½œä¸€ä¸ª"æµ®åŠ¨æ …ç”µå­é˜±"</li>
                        <li><strong>æ“¦é™¤æ“ä½œ</strong>ï¼ˆåŠ é«˜å‹ï¼‰ï¼šå°†ç”µå­æ³¨å…¥æ …æ â†’ æ•°æ®å˜1ï¼ˆå…¨FFï¼‰</li>
                        <li><strong>å†™å…¥æ“ä½œ</strong>ï¼ˆéš§ç©¿æ•ˆåº”ï¼‰ï¼šå°†ç”µå­æ‹‰å‡º â†’ 1å¯ä»¥å˜0</li>
                        <li><strong>å…³é”®é™åˆ¶</strong>ï¼šæ²¡æœ‰æ“¦é™¤ï¼Œ0æ— æ³•å˜1ï¼</li>
                    </ul>

                    <h5 class="mt-3">ä½æ“ä½œç¤ºä¾‹:</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert alert-success">
                                <p class="mb-1"><strong>å¯ä»¥å†™å…¥ï¼ˆ1â†’0ï¼‰:</strong></p>
                                <p class="mb-1">åŸå€¼: <code>0xFF</code> = <span class="binary-display">11111111</span></p>
                                <p class="mb-1">å†™å…¥: <code>0x00</code> = <span class="binary-display">00000000</span></p>
                                <p class="mb-0 text-success">âœ“ æ‰€æœ‰ä½éƒ½æ˜¯1â†’0ï¼Œå¯ä»¥å†™å…¥</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-danger">
                                <p class="mb-1"><strong>ä¸èƒ½å†™å…¥ï¼ˆ0â†’1éœ€è¦æ“¦é™¤ï¼‰:</strong></p>
                                <p class="mb-1">åŸå€¼: <code>0xAA</code> = <span class="binary-display">10101010</span></p>
                                <p class="mb-1">å†™å…¥: <code>0x55</code> = <span class="binary-display">01010101</span></p>
                                <p class="mb-0 text-danger">âœ— ç¬¬1,3,5,7ä½éœ€è¦0â†’1ï¼Œå¿…é¡»å…ˆæ“¦é™¤</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentData = null;

// æ›´æ–°æ“¦é™¤æŒ‰é’®çš„Page ID
document.getElementById('pageSelect').addEventListener('change', function() {
    document.getElementById('erasePageId').textContent = this.value;
});

// æ£€æŸ¥å†™å…¥æŒ‰é’®
document.getElementById('checkWriteBtn').addEventListener('click', async function() {
    const pageId = parseInt(document.getElementById('pageSelect').value);
    const offset = parseInt(document.getElementById('offsetInput').value);
    const dataHex = document.getElementById('dataInput').value;

    try {
        const response = await fetch('/api/check_write', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({page_id: pageId, offset: offset, data_hex: dataHex})
        });

        currentData = await response.json();

        const resultCard = document.getElementById('resultCard');
        const resultContent = document.getElementById('resultContent');
        resultCard.style.display = 'block';

        if (currentData.can_write) {
            resultContent.innerHTML = `
                <div class="alert alert-success">
                    <h5>âœ“ å¯ä»¥ç›´æ¥å†™å…¥</h5>
                    ${currentData.details.map(d => `
                        <p>åœ°å€ 0x${d.offset.toString(16).padStart(2,'0').toUpperCase()}:
                        <span class="binary-display">${d.binary_current}</span> â†’
                        <span class="binary-display">${d.binary_new}</span></p>
                    `).join('')}
                </div>
            `;
        } else {
            resultContent.innerHTML = `
                <div class="alert alert-danger">
                    <h5>âœ— ä¸èƒ½ç›´æ¥å†™å…¥ï¼Œéœ€è¦å…ˆæ“¦é™¤</h5>
                    ${currentData.details.filter(d => !d.can_write).map(d => `
                        <p><strong>åœ°å€ 0x${d.offset.toString(16).padStart(2,'0').toUpperCase()}:</strong></p>
                        <p>åŸå€¼: <code>${d.current}</code> = <span class="binary-display">${d.binary_current}</span></p>
                        <p>å†™å…¥: <code>${d.new}</code> = <span class="binary-display">${d.binary_new}</span></p>
                        <p class="text-danger mb-0">${d.reason}</p>
                    `).join('')}
                </div>
            `;
        }

        // æ¿€æ´»æ“¦é™¤-å†™å…¥æµç¨‹
        document.getElementById('writeAfterEraseBtn').disabled = false;

    } catch (error) {
        console.error('Error:', error);
        alert('æ£€æŸ¥å¤±è´¥: ' + error);
    }
});

// æ“¦é™¤æŒ‰é’®
document.getElementById('eraseBtn').addEventListener('click', async function() {
    const pageId = parseInt(document.getElementById('pageSelect').value);

    try {
        const response = await fetch(`/api/page/${pageId}/erase`, {
            method: 'POST'
        });
        const result = await response.json();

        if (result.success) {
            const eraseBtn = document.getElementById('eraseBtn');
            eraseBtn.textContent = `âœ“ å·²æ“¦é™¤Page #${pageId}`;
            eraseBtn.disabled = true;
            eraseBtn.classList.remove('btn-danger');
            eraseBtn.classList.add('btn-success');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('æ“¦é™¤å¤±è´¥: ' + error);
    }
});

// æ“¦é™¤åå†™å…¥æŒ‰é’®
document.getElementById('writeAfterEraseBtn').addEventListener('click', async function() {
    const pageId = parseInt(document.getElementById('pageSelect').value);
    const offset = parseInt(document.getElementById('offsetInput').value);
    const dataHex = document.getElementById('dataInput').value;

    try {
        const response = await fetch('/api/erase_and_write', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({page_id: pageId, offset: offset, data_hex: dataHex})
        });

        const result = await response.json();

        const successResult = document.getElementById('successResult');
        const successContent = document.getElementById('successContent');
        successResult.style.display = 'block';
        successContent.innerHTML = `
            <p>Page #${pageId} å·²æ“¦é™¤å¹¶æˆåŠŸå†™å…¥æ•°æ®</p>
            <p>åœ°å€: 0x${(pageId * 256 + offset).toString(16).toUpperCase()}</p>
            <p>æ•°æ®: ${dataHex}</p>
        `;

    } catch (error) {
        console.error('Error:', error);
        alert('å†™å…¥å¤±è´¥: ' + error);
    }
});
</script>
{% endblock %}
