{% extends "base.html" %}

{% block title %}NvMé˜Ÿåˆ—ä¸çŠ¶æ€æœº - EEPROMå¯è§†åŒ–{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">âš™ï¸ NvM Jobé˜Ÿåˆ—ä¸çŠ¶æ€æœºå¯è§†åŒ–</h2>

    <div class="row mb-3">
        <!-- æ—¶é—´æ§åˆ¶ -->
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <label class="form-label">æ—¶é—´å€é€Ÿ:</label>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary" onclick="setSpeed(1)">1x</button>
                                <button class="btn btn-outline-primary" onclick="setSpeed(10)">10x</button>
                                <button class="btn btn-outline-primary" onclick="setSpeed(100)">100x</button>
                                <button class="btn btn-outline-danger" onclick="setSpeed(1000)">FASTEST</button>
                            </div>
                            <span class="ms-3">è™šæ‹Ÿæ—¶é—´: <strong id="virtualTime">0</strong> ms</span>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-success" onclick="startTick()" id="startBtn">â–¶ï¸ å¼€å§‹</button>
                            <button class="btn btn-warning" onclick="pauseTick()" id="pauseBtn" disabled>â¸ï¸ æš‚åœ</button>
                            <button class="btn btn-secondary" onclick="singleTick()">â­ï¸ å•æ­¥</button>
                            <button class="btn btn-danger" onclick="resetSim()">ğŸ”„ é‡ç½®</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- å·¦ä¾§ï¼šé˜Ÿåˆ—å’ŒJobæ§åˆ¶ -->
        <div class="col-md-6">
            <!-- Jobé˜Ÿåˆ— -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between">
                    <span>ğŸ“‹ Jobé˜Ÿåˆ—</span>
                    <span class="badge bg-primary">é•¿åº¦: <span id="queueLength">0</span></span>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <div id="jobQueue">
                        <p class="text-muted text-center">é˜Ÿåˆ—ä¸ºç©º</p>
                    </div>
                </div>
            </div>

            <!-- å½“å‰æ‰§è¡Œçš„Job -->
            <div class="card mb-3">
                <div class="card-header bg-success">
                    <span>ğŸ¯ æ­£åœ¨æ‰§è¡Œ</span>
                </div>
                <div class="card-body" id="currentJob">
                    <p class="text-muted text-center">æ— Jobæ‰§è¡Œä¸­</p>
                </div>
            </div>

            <!-- æ·»åŠ æ–°Job -->
            <div class="card">
                <div class="card-header">
                    <span>â• æ·»åŠ æ–°Job</span>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label">Jobç±»å‹:</label>
                            <select id="jobTypeSelect" class="form-select form-select-sm">
                                <option value="READ">ReadBlock</option>
                                <option value="WRITE">WriteBlock</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Block ID:</label>
                            <select id="blockIdSelect" class="form-select form-select-sm">
                                <option value="0">Block 0</option>
                                <option value="1">Block 1</option>
                                <option value="2">Block 2</option>
                                <option value="3">Block 3</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label">ä¼˜å…ˆçº§:</label>
                            <select id="prioritySelect" class="form-select form-select-sm">
                                <option value="LOW">LOW</option>
                                <option value="MED">MED</option>
                                <option value="HIGH">HIGH</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">
                                <input type="checkbox" id="immediateCheck"> Immediateæ’é˜Ÿ
                            </label>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100" onclick="enqueueJob()">
                        ğŸ“¤ å…¥é˜Ÿ
                    </button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šçŠ¶æ€æœºä¸æ€§èƒ½æŒ‡æ ‡ -->
        <div class="col-md-6">
            <!-- BlockçŠ¶æ€æœº -->
            <div class="card mb-3">
                <div class="card-header">
                    <span>ğŸ”„ BlockçŠ¶æ€æœº</span>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <div id="blockStates">
                        <!-- BlockçŠ¶æ€å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- æ€§èƒ½æŒ‡æ ‡ -->
            <div class="card">
                <div class="card-header">
                    <span>ğŸ“Š æ€§èƒ½æŒ‡æ ‡</span>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 id="completedJobs">0</h4>
                            <small>å·²å®Œæˆ</small>
                        </div>
                        <div class="col-4">
                            <h4 id="avgExecTime">0</h4>
                            <small>å¹³å‡æ‰§è¡Œ(ms)</small>
                        </div>
                        <div class="col-4">
                            <h4 id="retryCount">0</h4>
                            <small>é‡è¯•æ¬¡æ•°</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <strong>æœ€å¤§é˜Ÿåˆ—é•¿åº¦:</strong> <span id="maxQueueLen">0</span>
                        </div>
                        <div class="col-6">
                            <strong>è¶…æ—¶è®¡æ•°:</strong> <span id="timeoutCount">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isRunning = false;
let tickInterval = null;
let currentSpeed = 1;

// å…¥é˜ŸJob
async function enqueueJob() {
    const jobType = document.getElementById('jobTypeSelect').value;
    const blockId = parseInt(document.getElementById('blockIdSelect').value);
    const priority = document.getElementById('prioritySelect').value;
    const immediate = document.getElementById('immediateCheck').checked;

    try {
        const response = await fetch('/api/nvm/enqueue', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                job_type: jobType,
                block_id: blockId,
                priority: priority,
                immediate: immediate
            })
        });

        const result = await response.json();
        if (result.success) {
            await updateDisplay();
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// å•æ­¥æ‰§è¡Œ
async function singleTick() {
    try {
        const response = await fetch('/api/nvm/tick', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ms: 10})
        });

        const snapshot = await response.json();
        updateDisplayWithData(snapshot);
    } catch (error) {
        console.error('Error:', error);
    }
}

// æ›´æ–°æ˜¾ç¤º
async function updateDisplay() {
    try {
        const response = await fetch('/api/nvm/metrics');
        const metrics = await response.json();
        updateDisplayWithData({metrics: metrics});
    } catch (error) {
        console.error('Error:', error);
    }
}

// ä½¿ç”¨å¿«ç…§æ•°æ®æ›´æ–°æ˜¾ç¤º
function updateDisplayWithData(snapshot) {
    const metrics = snapshot.metrics;

    // æ›´æ–°è™šæ‹Ÿæ—¶é—´
    document.getElementById('virtualTime').textContent = metrics.virtual_time;

    // æ›´æ–°é˜Ÿåˆ—
    const queueSnapshot = snapshot.queue_snapshot || [];
    const queueDiv = document.getElementById('jobQueue');
    if (queueSnapshot.length === 0) {
        queueDiv.innerHTML = '<p class="text-muted text-center">é˜Ÿåˆ—ä¸ºç©º</p>';
    } else {
        queueDiv.innerHTML = queueSnapshot.map((job, idx) => `
            <div class="card mb-2 ${job.immediate ? 'border-danger' : ''}">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between">
                        <strong>#${job.job_id}</strong>
                        <span class="badge bg-${job.priority === 'HIGH' ? 'danger' : job.priority === 'MED' ? 'warning' : 'secondary'}">
                            ${job.priority}
                        </span>
                        ${job.immediate ? '<span class="badge bg-danger">IMMEDIATE</span>' : ''}
                    </div>
                    <small class="text-muted">
                        ${job.type} Block${job.block_id} | ç­‰å¾…: ${job.wait_time}ms | çŠ¶æ€: ${job.state}
                    </small>
                </div>
            </div>
        `).join('');
    }

    document.getElementById('queueLength').textContent = queueSnapshot.length;

    // æ›´æ–°å½“å‰Job
    const currentJob = snapshot.current_job;
    const currentJobDiv = document.getElementById('currentJob');
    if (currentJob) {
        currentJobDiv.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h5>#${currentJob.job_id} - ${currentJob.type}</h5>
                    <p><strong>Block:</strong> ${currentJob.block_id}</p>
                    <p><strong>çŠ¶æ€:</strong> <span class="badge bg-success">${currentJob.state}</span></p>
                </div>
            </div>
        `;
    } else {
        currentJobDiv.innerHTML = '<p class="text-muted text-center">æ— Jobæ‰§è¡Œä¸­</p>';
    }

    // æ›´æ–°BlockçŠ¶æ€
    const blocks = snapshot.blocks || {};
    const blocksDiv = document.getElementById('blockStates');
    blocksDiv.innerHTML = Object.entries(blocks).map(([blockId, block]) => `
        <div class="card mb-2">
            <div class="card-body p-2">
                <strong>Block ${blockId}:</strong>
                <span class="badge bg-${block.state === 'IDLE' ? 'secondary' : 'primary'} ms-2">${block.state}</span>
                ${block.history && block.history.length > 0 ? `
                    <small class="d-block mt-1">
                        æœ€è¿‘: ${block.history.slice(-3).map(h => `${h.state}@${h.timestamp}ms`).join(' â†’ ')}
                    </small>
                ` : ''}
            </div>
        </div>
    `).join('');

    // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
    document.getElementById('completedJobs').textContent = metrics.completed_jobs;
    document.getElementById('avgExecTime').textContent = metrics.avg_exec_time;
    document.getElementById('retryCount').textContent = metrics.retry_count;
    document.getElementById('maxQueueLen').textContent = metrics.max_queue_length;
    document.getElementById('timeoutCount').textContent = metrics.deadline_miss_count;
}

// å¼€å§‹è‡ªåŠ¨æ‰§è¡Œ
function startTick() {
    if (!isRunning) {
        isRunning = true;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('pauseBtn').disabled = false;

        tickInterval = setInterval(async () => {
            await singleTick();
        }, 1000 / currentSpeed);
    }
}

// æš‚åœ
function pauseTick() {
    isRunning = false;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('pauseBtn').disabled = true;

    if (tickInterval) {
        clearInterval(tickInterval);
        tickInterval = null;
    }
}

// è®¾ç½®å€é€Ÿ
async function setSpeed(speed) {
    currentSpeed = speed;

    // æ›´æ–°API
    try {
        await fetch('/api/nvm/time_scale', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({scale: speed})
        });
    } catch (error) {
        console.error('Error:', error);
    }

    // å¦‚æœæ­£åœ¨è¿è¡Œï¼Œé‡å¯å®šæ—¶å™¨
    if (isRunning) {
        pauseTick();
        startTick();
    }
}

// é‡ç½®
async function resetSim() {
    pauseTick();

    try {
        await fetch('/api/nvm/reset', {
            method: 'POST'
        });
        await updateDisplay();
    } catch (error) {
        console.error('Error:', error);
    }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    updateDisplay();
});
</script>
{% endblock %}
