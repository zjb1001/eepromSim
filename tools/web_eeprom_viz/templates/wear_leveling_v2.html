{% extends "base.html" %}

{% block title %}ç£¨æŸå‡è¡¡ - Pageå¯¿å‘½ç«èµ›{% endblock %}

{% block content %}
<div class="page-shell container-fluid h-100 d-flex flex-column">
    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <div class="mb-3">
        <h2 class="mb-2">ğŸƒ Pageå¯¿å‘½ç«èµ›ï¼šè°å…ˆæŒ‚æ‰ï¼Ÿ</h2>
        <div class="alert alert-warning mb-0">
            <strong>ğŸ¯ å®éªŒç›®æ ‡:</strong> å¯¹æ¯”ä¸‰ç§ç£¨æŸå‡è¡¡ç­–ç•¥ï¼Œçœ‹å“ªç§ç­–ç•¥èƒ½è®©EEPROMå¯¿å‘½æœ€é•¿ï¼<br>
            <small>æ¯ä¸ªPageåªèƒ½æ“¦é™¤100æ¬¡å°±æŠ¥åºŸï¼Œçœ‹çœ‹ä¸åŒç­–ç•¥ä¸‹Pageçš„æ­»äº¡é¡ºåº</small>
        </div>
    </div>

    <!-- å·¦å³å¸ƒå±€: å·¦ä¾§å¯è§†åŒ–ï¼Œå³ä¾§æ“ä½œ -->
    <div class="row flex-grow-1 g-3">
        <!-- å·¦ä¾§: å¯è§†åŒ–åŒºåŸŸ (58%) -->
        <div class="col-lg-7">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ“Š Pageå¯¿å‘½ç›‘æ§ (æ¯ä¸ªPageå¯æ“¦é™¤100æ¬¡)</h5>
                    <div>
                        <span class="badge bg-danger me-2">ğŸ’€ å·²æ­»äº¡: <span id="deadCount">0</span></span>
                        <span class="badge bg-warning">âš ï¸ æ¿’å±: <span id="lowCount">0</span></span>
                    </div>
                </div>
                <div class="card-body d-flex flex-column">
                    <!-- Pageå¯¿å‘½æ¡ç½‘æ ¼ -->
                    <div id="pageBars" class="page-bars flex-grow-1">
                        <!-- 16ä¸ªPageçš„å¯¿å‘½æ¡ -->
                    </div>

                    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                    <div class="row mt-3 g-3">
                        <div class="col-6 col-md-3">
                            <div class="stat-box text-center">
                                <h3 class="text-primary mb-0" id="statTotalWrites">0</h3>
                                <small>æ€»å†™å…¥æ¬¡æ•°</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stat-box text-center">
                                <h3 class="text-danger mb-0" id="statMaxErase">0</h3>
                                <small>æœ€å¤§æ“¦é™¤æ¬¡æ•°</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stat-box text-center">
                                <h3 class="text-warning mb-0" id="statMinErase">0</h3>
                                <small>æœ€å°æ“¦é™¤æ¬¡æ•°</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stat-box text-center">
                                <h3 class="text-info mb-0" id="statImbalance">0x</h3>
                                <small>ä¸å‡åŒ€åº¦</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§: æ“ä½œé¢æ¿ (42%) -->
        <div class="col-lg-5">
            <div class="d-flex flex-column gap-3 h-100">
                <!-- ç­–ç•¥é€‰æ‹©å¡ç‰‡ -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">âš™ï¸ ç­–ç•¥é€‰æ‹©</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-danger" onclick="runSimulation('none')" id="btnNone">
                                âŒ æ— å‡è¡¡ (æ€»æ˜¯Page 0)
                            </button>
                            <button class="btn btn-warning" onclick="runSimulation('round_robin')" id="btnRoundRobin">
                                ğŸ”„ è½®è¯¢å‡è¡¡ (å‡åŒ€åˆ†é…)
                            </button>
                            <button class="btn btn-success" onclick="runSimulation('dynamic')" id="btnDynamic">
                                â­ åŠ¨æ€å‡è¡¡ (æ™ºèƒ½é€‰æ‹©)
                            </button>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <label class="form-label">æ¨¡æ‹Ÿå†™å…¥æ¬¡æ•°:</label>
                            <input type="range" id="writeCount" class="form-range" min="10" max="1000" value="100" step="10">
                            <div class="text-center">
                                <span class="badge bg-primary" style="font-size: 1.2em;">
                                    <span id="writeCountDisplay">100</span> æ¬¡å†™å…¥
                                </span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">åŠ¨ç”»é€Ÿåº¦:</label>
                            <select id="speedSelect" class="form-select">
                                <option value="200">æ…¢é€Ÿ (æ•™å­¦)</option>
                                <option value="50" selected>æ­£å¸¸</option>
                                <option value="10">å¿«é€Ÿ</option>
                                <option value="0">ç¬é—´å®Œæˆ</option>
                            </select>
                        </div>

                        <div class="alert alert-info mb-0">
                            <h6 class="mb-2">ğŸ’¡ ç­–ç•¥è¯´æ˜:</h6>
                            <p class="small mb-0" id="strategyDescription">
                                é€‰æ‹©ä¸€ä¸ªç­–ç•¥å¹¶ç‚¹å‡»è¿è¡Œï¼Œè§‚å¯ŸPageå¯¿å‘½çš„å˜åŒ–ã€‚
                            </p>
                        </div>
                    </div>
                </div>

                <!-- å†™å…¥æ—¥å¿—å¡ç‰‡ -->
                <div class="card flex-grow-1">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">ğŸ“‹ å†™å…¥æ—¥å¿—</h5>
                    </div>
                    <div class="card-body" style="max-height: 250px; overflow-y: auto;">
                        <div id="writeLog">
                            <p class="text-muted text-center">é€‰æ‹©ç­–ç•¥å¹¶è¿è¡Œæ¨¡æ‹Ÿ...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ç¡®ä¿ä¸»è¦å†…å®¹åŒºåŸŸå……æ»¡å¯ç”¨ç©ºé—´ï¼Œä½†ä¸å½±å“å¯¼èˆªæ å®¹å™¨ */
.page-shell {
    min-height: calc(100vh - 100px);
}

/* Pageå¯¿å‘½æ¡ç½‘æ ¼ */
.page-bars {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 8px;
    padding: 10px;
    min-height: 280px;
    max-width: 100%;
}

.page-bar-container {
    text-align: center;
}

.page-bar {
    width: 100%;
    height: 200px;
    background: #f0f0f0;
    border-radius: 4px;
    position: relative;
    overflow: hidden;
    margin-bottom: 6px;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
}

.page-bar-fill {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    transition: height 0.3s ease, background 0.3s ease;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
    padding-bottom: 5px;
}

.page-dead {
    background: #74b9ff !important;
    opacity: 0.3;
    animation: death-pulse 2s infinite;
}

.page-dead::after {
    content: 'ğŸ’€';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 32px;
}

@keyframes death-pulse {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 0.5; }
}

.page-label {
    font-weight: bold;
    color: #2d3436;
    font-size: 14px;
}

/* ç»Ÿè®¡æ¡† */
.stat-box {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

/* æ“ä½œæ—¥å¿— */
.log-entry {
    padding: 8px;
    margin-bottom: 5px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    border-left: 3px solid #6c757d;
}

.log-write {
    background: #e9ecef;
    border-left-color: #6c757d;
}

.log-dead {
    background: #f8d7da;
    border-left-color: #dc3545;
    color: #721c24;
}

.log-info {
    background: #d1ecf1;
    border-left-color: #17a2b8;
    color: #0c5460;
}

/* å“åº”å¼ */
@media (max-width: 991px) {
    .page-shell {
        min-height: auto;
    }

    .page-bars {
        grid-template-columns: repeat(4, 1fr);
        min-height: 300px;
    }

    .page-bar {
        height: 180px;
    }
}

@media (max-width: 575px) {
    .page-bars {
        grid-template-columns: repeat(2, 1fr);
    }

    .page-bar {
        height: 150px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let pageErases = new Array(16).fill(0);
const MAX_ERASE = 100;
let isRunning = false;
let currentStrategy = '';

// ç­–ç•¥è¯´æ˜
const strategyDescriptions = {
    'none': '<strong>âŒ æ— å‡è¡¡ç­–ç•¥:</strong> æ€»æ˜¯å†™å…¥Page #0ï¼Œå¯¼è‡´Page 0å¿«é€Ÿæ­»äº¡ï¼Œå…¶ä»–15ä¸ªPageå®Œå…¨é—²ç½®ã€‚è¿™æ˜¯æœ€ç³Ÿç³•çš„ç­–ç•¥ï¼Œæµªè´¹äº†94%çš„å­˜å‚¨å®¹é‡ï¼',
    'round_robin': '<strong>ğŸ”„ è½®è¯¢å‡è¡¡ç­–ç•¥:</strong> è½®æµå†™å…¥16ä¸ªPageï¼Œç¡®ä¿æ‰€æœ‰Pageå‡åŒ€ä½¿ç”¨ã€‚è™½ç„¶ç®€å•æœ‰æ•ˆï¼Œä½†æ— æ³•åº”å¯¹å·²æŸåçš„Pageã€‚',
    'dynamic': '<strong>â­ åŠ¨æ€å‡è¡¡ç­–ç•¥:</strong> æ€»æ˜¯é€‰æ‹©æ“¦é™¤æ¬¡æ•°æœ€å°‘ï¼ˆæœ€å¥åº·ï¼‰çš„Pageã€‚æ™ºèƒ½åˆ†é…ï¼Œå¯¿å‘½æœ€å¤§åŒ–ï¼Œæ˜¯æœ€ä¼˜çš„ç­–ç•¥ï¼'
};

// æ›´æ–°ç­–ç•¥è¯´æ˜
function updateStrategyDescription(strategy) {
    document.getElementById('strategyDescription').innerHTML = strategyDescriptions[strategy];
}

// åˆå§‹åŒ–Pageæ¡
function initPageBars() {
    const container = document.getElementById('pageBars');
    container.innerHTML = '';

    for (let i = 0; i < 16; i++) {
        const div = document.createElement('div');
        div.className = 'page-bar-container';
        div.innerHTML = `
            <div class="page-bar" id="bar-${i}">
                <div class="page-bar-fill" id="fill-${i}" style="height: 100%; background: #00b894;">
                    ${MAX_ERASE}
                </div>
            </div>
            <div class="page-label">Page ${i}</div>
            <div id="status-${i}" class="text-success small">100% å¯¿å‘½</div>
        `;
        container.appendChild(div);
    }
}

// æ›´æ–°Pageæ˜¾ç¤º
function updatePageDisplay(pageId) {
    const eraseCount = pageErases[pageId];
    const lifePercent = Math.max(0, MAX_ERASE - eraseCount);
    const lifePercentDisplay = ((MAX_ERASE - eraseCount) / MAX_ERASE * 100).toFixed(0);

    const fill = document.getElementById(`fill-${pageId}`);
    const status = document.getElementById(`status-${pageId}`);

    fill.style.height = `${lifePercent}%`;
    fill.textContent = lifePercent;

    // é¢œè‰²æ ¹æ®å¯¿å‘½å˜åŒ–
    if (eraseCount >= MAX_ERASE) {
        fill.style.background = '#74b9ff';
        fill.parentElement.classList.add('page-dead');
        status.textContent = 'å·²æ­»äº¡ ğŸ’€';
        status.className = 'text-danger small';
    } else if (lifePercent < 20) {
        fill.style.background = '#d63031';
        status.textContent = `${lifePercentDisplay}% æ¿’å±`;
        status.className = 'text-danger small';
    } else if (lifePercent < 50) {
        fill.style.background = '#fdcb6e';
        status.textContent = `${lifePercentDisplay}% å¯¿å‘½`;
        status.className = 'text-warning small';
    } else {
        fill.style.background = '#00b894';
        status.textContent = `${lifePercentDisplay}% å¯¿å‘½`;
        status.className = 'text-success small';
    }

    updateStats();
}

// æ›´æ–°ç»Ÿè®¡
function updateStats() {
    const totalWrites = pageErases.reduce((a, b) => a + b, 0);
    const maxErase = Math.max(...pageErases);
    const minErase = Math.min(...pageErases);
    const imbalance = maxErase / Math.max(minErase, 1);

    document.getElementById('statTotalWrites').textContent = totalWrites;
    document.getElementById('statMaxErase').textContent = maxErase;
    document.getElementById('statMinErase').textContent = minErase;
    document.getElementById('statImbalance').textContent = imbalance.toFixed(1) + 'x';

    const deadCount = pageErases.filter(e => e >= MAX_ERASE).length;
    const lowCount = pageErases.filter(e => e >= 80 && e < MAX_ERASE).length;
    document.getElementById('deadCount').textContent = deadCount;
    document.getElementById('lowCount').textContent = lowCount;
}

// æ·»åŠ æ—¥å¿—
function addLog(message, type = 'write') {
    const log = document.getElementById('writeLog');
    const entry = document.createElement('div');
    entry.className = `log-entry log-${type}`;
    entry.textContent = message;

    if (log.querySelector('.text-muted')) {
        log.innerHTML = '';
    }

    log.insertBefore(entry, log.firstChild);

    // é™åˆ¶æ—¥å¿—æ•°é‡
    while (log.children.length > 50) {
        log.removeChild(log.lastChild);
    }
}

// é€‰æ‹©Pageï¼ˆæ ¹æ®ç­–ç•¥ï¼‰
function selectPage(strategy, writeNum) {
    if (strategy === 'none') {
        return 0;  // æ€»æ˜¯å†™Page 0
    } else if (strategy === 'round_robin') {
        return writeNum % 16;
    } else if (strategy === 'dynamic') {
        // é€‰æ‹©æ“¦é™¤æ¬¡æ•°æœ€å°‘çš„Page
        let minErase = Infinity;
        let minPage = 0;
        for (let i = 0; i < 16; i++) {
            if (pageErases[i] < minErase) {
                minErase = pageErases[i];
                minPage = i;
            }
        }
        return minPage;
    }
    return 0;
}

// è¿è¡Œæ¨¡æ‹Ÿ
async function runSimulation(strategy) {
    if (isRunning) return;
    isRunning = true;
    currentStrategy = strategy;

    // æ›´æ–°ç­–ç•¥è¯´æ˜
    updateStrategyDescription(strategy);

    const writeCount = parseInt(document.getElementById('writeCount').value);
    const speed = parseInt(document.getElementById('speedSelect').value);

    // é‡ç½®
    pageErases.fill(0);
    initPageBars();
    updateStats();
    document.getElementById('writeLog').innerHTML = '<p class="text-muted text-center">æ¨¡æ‹Ÿå¼€å§‹...</p>';

    const strategyNames = {
        'none': 'âŒ æ— å‡è¡¡',
        'round_robin': 'ğŸ”„ è½®è¯¢å‡è¡¡',
        'dynamic': 'â­ åŠ¨æ€å‡è¡¡'
    };

    addLog(`å¼€å§‹æ¨¡æ‹Ÿ: ${strategyNames[strategy]}`, 'info');
    await sleep(speed * 2);

    // é€æ¬¡å†™å…¥
    for (let i = 0; i < writeCount; i++) {
        const pageId = selectPage(strategy, i);

        // æ£€æŸ¥Pageæ˜¯å¦å·²æ­»
        if (pageErases[pageId] >= MAX_ERASE) {
            addLog(`#${i + 1}: Page ${pageId}å·²æ­»äº¡ï¼Œè·³è¿‡`, 'dead');
            continue;
        }

        pageErases[pageId]++;
        updatePageDisplay(pageId);

        const strategyText = {
            'none': `å†™å…¥ Page ${pageId} (æ€»æ˜¯Page 0)`,
            'round_robin': `å†™å…¥ Page ${pageId} (è½®è¯¢)`,
            'dynamic': `å†™å…¥ Page ${pageId} (é€‰æœ€å¥åº·çš„)`
        };

        addLog(`#${i + 1}: ${strategyText[strategy]} - æ“¦é™¤æ¬¡æ•°: ${pageErases[pageId]}`, 'write');

        if (pageErases[pageId] >= MAX_ERASE) {
            addLog(`ğŸ’€ Page ${pageId}æ­»äº¡ï¼`, 'dead');
        }

        if (speed > 0) {
            await sleep(speed);
        }
    }

    isRunning = false;
    addLog(`æ¨¡æ‹Ÿå®Œæˆï¼æ€»å†™å…¥: ${writeCount}æ¬¡`, 'info');

    // ç»“æœæ€»ç»“
    showSummary(strategy);
}

// æ˜¾ç¤ºæ€»ç»“
function showSummary(strategy) {
    const totalWrites = pageErases.reduce((a, b) => a + b, 0);
    const deadCount = pageErases.filter(e => e >= MAX_ERASE).length;
    const maxErase = Math.max(...pageErases);
    const minErase = Math.min(...pageErases);

    let summary = '';
    if (strategy === 'none') {
        summary = `
            <strong>ç»“æœåˆ†æ:</strong>
            <ul class="mb-0">
                <li>Page 0è¢«å†™å…¥${maxErase}æ¬¡ï¼Œ${maxErase >= MAX_ERASE ? 'å·²æ­»äº¡' : 'æ¿’ä¸´æ­»äº¡'} ğŸ’€</li>
                <li>å…¶ä»–15ä¸ªPageå®Œå…¨é—²ç½® ğŸ˜´</li>
                <li>EEPROMå®é™…å¯¿å‘½åªç”¨äº† ${((totalWrites / MAX_ERASE / 16) * 100).toFixed(1)}%</li>
                <li><strong>ç»“è®º:</strong> æµªè´¹äº†94%çš„å­˜å‚¨å®¹é‡ï¼</li>
            </ul>
        `;
    } else if (strategy === 'round_robin') {
        summary = `
            <strong>ç»“æœåˆ†æ:</strong>
            <ul class="mb-0">
                <li>æ‰€æœ‰Pageå‡åŒ€ä½¿ç”¨ âœ…</li>
                <li>ä¸å‡åŒ€åº¦: ${(maxErase / Math.max(minErase, 1)).toFixed(1)}x</li>
                <li>${deadCount > 0 ? deadCount + 'ä¸ªPageå·²æ­»äº¡' : 'æ‰€æœ‰Pageå¥åº·'}</li>
                <li><strong>ç»“è®º:</strong> å¯¿å‘½å»¶é•¿16å€ï¼</li>
            </ul>
        `;
    } else if (strategy === 'dynamic') {
        summary = `
            <strong>ç»“æœåˆ†æ:</strong>
            <ul class="mb-0">
                <li>æ™ºèƒ½åˆ†é…ï¼Œæ€»æ˜¯é€‰æœ€å¥åº·çš„Page ğŸ§ </li>
                <li>ä¸å‡åŒ€åº¦: ${(maxErase / Math.max(minErase, 1)).toFixed(1)}x (æœ€ä¼˜)</li>
                <li>${deadCount > 0 ? deadCount + 'ä¸ªPageå·²æ­»äº¡' : 'æ‰€æœ‰Pageå¥åº·'}</li>
                <li><strong>ç»“è®º:</strong> å¯¿å‘½æœ€å¤§åŒ–ï¼</li>
            </ul>
        `;
    }

    addLog(summary, 'info');
}

// è¾…åŠ©å‡½æ•°
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// äº‹ä»¶ç›‘å¬
document.getElementById('writeCount').addEventListener('input', function() {
    document.getElementById('writeCountDisplay').textContent = this.value;
});

// é¡µé¢åŠ è½½åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initPageBars();
    updateStats();
});
</script>
{% endblock %}
