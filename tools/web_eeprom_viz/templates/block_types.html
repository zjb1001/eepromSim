{% extends "base.html" %}

{% block title %}Blockç±»å‹å¯¹æ¯” - EEPROMå¯è§†åŒ–{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">ğŸ“¦ NvM Blockç±»å‹å¯¹æ¯”ä¸æ¢å¤æœºåˆ¶</h2>

    <div class="alert alert-info">
        <strong>ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ:</strong> NvMæ”¯æŒä¸‰ç§Blockç±»å‹ï¼Œæä¾›ä¸åŒçš„æ•°æ®ä¿æŠ¤çº§åˆ«ã€‚
        <strong>Native</strong>: å•ä»½æ•°æ® â†’ <strong>Redundant</strong>: åŒä»½å¤‡ä»½ â†’
        <strong>Dataset</strong>: å¤šç‰ˆæœ¬ç®¡ç†ã€‚æ ¹æ®æ•°æ®é‡è¦æ€§é€‰æ‹©åˆé€‚çš„ç±»å‹ã€‚
    </div>

    <!-- Blockç±»å‹å¯¹æ¯”è¡¨ -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“Š Blockç±»å‹ç‰¹æ€§å¯¹æ¯”</h5>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>ç‰¹æ€§</th>
                                <th>Native (Block 0)</th>
                                <th>Redundant (Block 1)</th>
                                <th>Dataset (Block 2)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>å­˜å‚¨ç»“æ„</strong></td>
                                <td>å•ä»½æ•°æ®</td>
                                <td>ä¸»æ•°æ® + å¤‡ä»½</td>
                                <td>å¤šç‰ˆæœ¬æ•°æ®</td>
                            </tr>
                            <tr>
                                <td><strong>å­˜å‚¨å¼€é”€</strong></td>
                                <td>1x</td>
                                <td>2x</td>
                                <td>Nx (ç‰ˆæœ¬æ•°é‡)</td>
                            </tr>
                            <tr>
                                <td><strong>æ¢å¤èƒ½åŠ›</strong></td>
                                <td><span class="text-danger">âŒ æ— å¤‡ä»½</span></td>
                                <td><span class="text-success">âœ… å¤‡ä»½æ¢å¤</span></td>
                                <td><span class="text-success">âœ… ç‰ˆæœ¬å›é€€</span></td>
                            </tr>
                            <tr>
                                <td><strong>å†™æ”¾å¤§</strong></td>
                                <td>1x</td>
                                <td>2x (å†™ä¸»+å¤‡)</td>
                                <td>Nx (å†™æ–°ç‰ˆæœ¬)</td>
                            </tr>
                            <tr>
                                <td><strong>é€‚ç”¨åœºæ™¯</strong></td>
                                <td>éå…³é”®æ•°æ®</td>
                                <td>å…³é”®æ•°æ®</td>
                                <td>éœ€è¦ç‰ˆæœ¬å›é€€çš„æ•°æ®</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- å½“å‰BlockçŠ¶æ€ -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ” å½“å‰BlockçŠ¶æ€</h5>
                </div>
                <div class="card-body">
                    <div class="row" id="blockStatusRow">
                        <!-- BlockçŠ¶æ€å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- å·¦ä¾§ï¼šæ•…éšœæ³¨å…¥ -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-danger">
                    <h5>âš ï¸ æ•…éšœæ³¨å…¥å®éªŒ</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©Block:</label>
                        <select id="faultBlockSelect" class="form-select">
                            <option value="0">Block 0 (Native)</option>
                            <option value="1">Block 1 (Redundant)</option>
                            <option value="2">Block 2 (Dataset)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ•…éšœç±»å‹:</label>
                        <select id="faultTypeSelect" class="form-select">
                            <option value="bit_flip">ä½ç¿»è½¬ (1å­—èŠ‚ç¿»è½¬)</option>
                            <option value="complete_corruption">å®Œå…¨æŸå</option>
                            <option value="backup_corruption">å¤‡ä»½æŸå (ä»…Redundant)</option>
                            <option value="version_loss">ç‰ˆæœ¬ä¸¢å¤± (ä»…Dataset)</option>
                        </select>
                    </div>

                    <button class="btn btn-danger w-100 mb-3" onclick="injectFault()">
                        ğŸ’¥ æ³¨å…¥æ•…éšœ
                    </button>

                    <!-- æ•…éšœæ—¥å¿— -->
                    <div id="faultLog" class="alert alert-warning" style="display:none;">
                        <h6>ğŸ“ æ•…éšœæ—¥å¿—:</h6>
                        <div id="faultLogContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ¢å¤å®éªŒ -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success">
                    <h5>ğŸ”§ æ•°æ®æ¢å¤å®éªŒ</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©è¦æ¢å¤çš„Block:</label>
                        <select id="recoverBlockSelect" class="form-select">
                            <option value="0">Block 0 (Native)</option>
                            <option value="1">Block 1 (Redundant)</option>
                            <option value="2">Block 2 (Dataset)</option>
                        </select>
                    </div>

                    <button class="btn btn-success w-100 mb-3" onclick="attemptRecovery()">
                        ğŸ”„ å°è¯•æ¢å¤
                    </button>

                    <!-- æ¢å¤ç»“æœ -->
                    <div id="recoveryResult" style="display:none;">
                        <h6>ğŸ“Š æ¢å¤ç»“æœ:</h6>
                        <div class="card bg-light">
                            <div class="card-body">
                                <p class="mb-1"><strong>æ¢å¤æ–¹æ³•:</strong> <span id="recoveryMethod"></span></p>
                                <p class="mb-1"><strong>æ¢å¤çŠ¶æ€:</strong> <span id="recoverySuccess"></span></p>
                                <p class="mb-0"><strong>è¯¦ç»†ä¿¡æ¯:</strong> <span id="recoveryMessage"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Datasetç‰ˆæœ¬ç®¡ç† -->
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info">
                    <h5>ğŸ“š Datasetç‰ˆæœ¬ç®¡ç†æ¼”ç¤º</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-secondary">
                        <strong>è¯´æ˜:</strong> åªæœ‰Datasetç±»å‹çš„Blockæ”¯æŒç‰ˆæœ¬ç®¡ç†ã€‚
                        æ¯æ¬¡å†™å…¥æ–°æ•°æ®æ—¶ï¼Œæ—§ç‰ˆæœ¬ä¼šä¿å­˜åˆ°å†å²è®°å½•ä¸­ï¼Œæ”¯æŒç‰ˆæœ¬å›é€€ã€‚
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Block ID (ä»…æ”¯æŒDataset):</label>
                                <select id="versionBlockSelect" class="form-select">
                                    <option value="2">Block 2 (Dataset)</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">æ–°ç‰ˆæœ¬æ•°æ® (Hex):</label>
                                <input type="text" id="newVersionData" class="form-control"
                                       value="DD" placeholder="ä¾‹å¦‚: DD">
                            </div>

                            <button class="btn btn-primary w-100" onclick="writeNewVersion()">
                                âœï¸ å†™å…¥æ–°ç‰ˆæœ¬
                            </button>
                        </div>

                        <div class="col-md-6">
                            <div id="versionHistory">
                                <h6>ğŸ“œ ç‰ˆæœ¬å†å²:</h6>
                                <div id="versionHistoryContent">
                                    <!-- ç‰ˆæœ¬å†å²å°†åŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œæ§åˆ¶ -->
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <button class="btn btn-secondary w-100" onclick="resetSimulation()">
                        ğŸ”„ é‡ç½®æ‰€æœ‰Block
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// æ³¨å…¥æ•…éšœ
async function injectFault() {
    const blockId = parseInt(document.getElementById('faultBlockSelect').value);
    const faultType = document.getElementById('faultTypeSelect').value;

    try {
        const response = await fetch('/api/blocktypes/inject_fault', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                block_id: blockId,
                fault_type: faultType
            })
        });

        const result = await response.json();

        // Show fault log
        const faultLog = document.getElementById('faultLog');
        faultLog.style.display = 'block';
        document.getElementById('faultLogContent').innerHTML =
            `<p class="mb-0"><strong>${result.fault_type}</strong> injected into Block ${result.block_id} (${result.block_type})</p>`;

        await updateStatus();

    } catch (error) {
        console.error('Error:', error);
        alert('æ•…éšœæ³¨å…¥å¤±è´¥: ' + error);
    }
}

// å°è¯•æ¢å¤
async function attemptRecovery() {
    const blockId = parseInt(document.getElementById('recoverBlockSelect').value);

    try {
        const response = await fetch('/api/blocktypes/recover', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({block_id: blockId})
        });

        const result = await response.json();

        document.getElementById('recoveryResult').style.display = 'block';
        document.getElementById('recoveryMethod').textContent = result.method;
        document.getElementById('recoverySuccess').innerHTML = result.success ?
            '<span class="text-success">âœ… æˆåŠŸ</span>' :
            '<span class="text-danger">âŒ å¤±è´¥</span>';
        document.getElementById('recoveryMessage').textContent = result.message;

        await updateStatus();

    } catch (error) {
        console.error('Error:', error);
        alert('æ¢å¤å¤±è´¥: ' + error);
    }
}

// å†™å…¥æ–°ç‰ˆæœ¬ (Dataset)
async function writeNewVersion() {
    const blockId = parseInt(document.getElementById('versionBlockSelect').value);
    const newData = document.getElementById('newVersionData').value.trim() || 'DD';

    try {
        const response = await fetch('/api/blocktypes/write_version', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                block_id: blockId,
                new_data: newData
            })
        });

        const result = await response.json();

        if (result.success) {
            alert(`âœ… ç‰ˆæœ¬ ${result.previous_version} â†’ ${result.new_version} å·²å†™å…¥`);
        } else {
            alert('âŒ ' + result.error);
        }

        await updateStatus();

    } catch (error) {
        console.error('Error:', error);
        alert('å†™å…¥å¤±è´¥: ' + error);
    }
}

// é‡ç½®ä»¿çœŸ
async function resetSimulation() {
    try {
        await fetch('/api/blocktypes/reset', {method: 'POST'});

        document.getElementById('faultLog').style.display = 'none';
        document.getElementById('recoveryResult').style.display = 'none';

        await updateStatus();

    } catch (error) {
        console.error('Error:', error);
    }
}

// æ›´æ–°çŠ¶æ€
async function updateStatus() {
    try {
        const response = await fetch('/api/blocktypes/status');
        const status = await response.json();

        // Update block status cards
        const statusRow = document.getElementById('blockStatusRow');
        statusRow.innerHTML = Object.entries(status.blocks).map(([bid, block]) => {
            const typeBadge = {
                'Native': 'bg-primary',
                'Redundant': 'bg-success',
                'Dataset': 'bg-info'
            }[block.type];

            return `
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <strong>Block ${bid}</strong>
                            <span class="badge ${typeBadge} ms-2">${block.type}</span>
                        </div>
                        <div class="card-body">
                            <p class="mb-1"><strong>ç‰ˆæœ¬:</strong> ${block.version}</p>
                            <p class="mb-1"><strong>ç‰ˆæœ¬æ•°:</strong> ${block.num_versions}</p>
                            <p class="mb-1"><strong>æœ‰å¤‡ä»½:</strong> ${block.has_backup ? 'âœ…' : 'âŒ'}</p>
                            <p class="mb-1"><strong>çŠ¶æ€:</strong> <span class="${block.is_valid ? 'text-success' : 'text-danger'}">${block.is_valid ? 'âœ… æœ‰æ•ˆ' : 'âŒ æŸå'}</span></p>
                            <p class="mb-0"><strong>CRC16:</strong> <code>${block.checksum}</code></p>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // Update version history for Dataset (Block 2)
        if (status.blocks['2']) {
            const block2 = status.blocks['2'];
            const historyDiv = document.getElementById('versionHistoryContent');
            historyDiv.innerHTML = `
                <p class="mb-1">å½“å‰ç‰ˆæœ¬: <strong>${block2.version}</strong></p>
                <p class="mb-1">æ€»ç‰ˆæœ¬æ•°: <strong>${block2.num_versions}</strong></p>
                <p class="mb-0 text-muted">Datasetæ”¯æŒç‰ˆæœ¬å›é€€ï¼Œå¯ä»¥åœ¨æ•°æ®æŸåæ—¶æ¢å¤åˆ°ä¹‹å‰çš„æœ‰æ•ˆç‰ˆæœ¬ã€‚</p>
            `;
        }

    } catch (error) {
        console.error('Error:', error);
    }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    updateStatus();
});
</script>
{% endblock %}
