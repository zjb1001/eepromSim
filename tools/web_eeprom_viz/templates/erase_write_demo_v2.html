{% extends "base.html" %}

{% block title %}æ“¦é™¤-å†™å…¥ä¾èµ– - äº¤äº’å¼å®éªŒ{% endblock %}

{% block content %}
<div class="page-shell container-fluid h-100 d-flex flex-column">
    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <div class="mb-3">
        <h2 class="mb-2">ğŸ¯ æŒ‘æˆ˜: ä½ èƒ½æŠŠ0xAAæ”¹æˆ0x55å—ï¼Ÿ</h2>
        <div class="alert alert-info mb-0">
            <strong>ğŸ“œ ä»»åŠ¡:</strong> Page #5 çš„åç§»10å¤„å­˜å‚¨äº†æ•°æ® <code>0xAA</code>ã€‚
            ä½ çš„ä»»åŠ¡æ˜¯å°†å…¶ä¿®æ”¹ä¸º <code>0x55</code>ã€‚<br>
            <small>æç¤º: EEPROMåªèƒ½å°†1å˜æˆ0ï¼Œä¸èƒ½å°†0å˜æˆ1ï¼ˆé™¤éæ“¦é™¤ï¼‰</small>
        </div>
    </div>

    <!-- å·¦å³å¸ƒå±€: å·¦ä¾§å¯è§†åŒ–ï¼Œå³ä¾§æ“ä½œ -->
    <div class="row flex-grow-1 g-3">
        <!-- å·¦ä¾§: å¯è§†åŒ–åŒºåŸŸ (58%) -->
        <div class="col-lg-7">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">ğŸ“¦ EEPROM Page #5 å¯è§†åŒ–</h5>
                    <span class="badge bg-secondary" id="pageStatus">å·²å†™å…¥æ•°æ®</span>
                </div>
                <div class="card-body d-flex flex-column">
                    <!-- Pageå­—èŠ‚ç½‘æ ¼ -->
                    <div id="pageGrid" class="eeprom-grid mb-3 flex-grow-1">
                        <!-- 16è¡Œ x 16åˆ— = 256å­—èŠ‚ -->
                    </div>

                    <!-- å›¾ä¾‹ -->
                    <div class="d-flex justify-content-center gap-4 flex-wrap">
                        <div class="d-flex align-items-center">
                            <div class="grid-cell-example" style="background: #e9ecef;"></div>
                            <small>æœªå†™å…¥ (0xFF)</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="grid-cell-example" style="background: #a8dadc;"></div>
                            <small>å·²å†™å…¥æ•°æ®</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="grid-cell-example" style="background: #ff6b6b;"></div>
                            <small>ç›®æ ‡ä½ç½®</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="grid-cell-example" style="background: #ffeaa7;"></div>
                            <small>å†™å…¥å¤±è´¥</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="grid-cell-example" style="background: #55efc4;"></div>
                            <small>å†™å…¥æˆåŠŸ</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§: æ“ä½œé¢æ¿ (42%) -->
        <div class="col-lg-5">
            <div class="d-flex flex-column gap-3 h-100">
                <!-- ä¿®æ”¹ç›®æ ‡å¡ç‰‡ -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">ğŸ¯ ä¿®æ”¹ç›®æ ‡</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">ç›®æ ‡ä½ç½® (å­—èŠ‚åç§»):</label>
                            <div class="input-group">
                                <input type="number" id="offsetInput" class="form-control" value="10" min="0" max="255" readonly>
                                <span class="input-group-text">= åœ°å€ 0x{{ "%04X"|format(5 * 256 + 10) }}</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">å½“å‰å€¼:</label>
                            <div class="input-group">
                                <span class="input-group-text">Hex</span>
                                <input type="text" class="form-control" id="currentValueHex" value="AA" readonly>
                                <span class="input-group-text">Bin</span>
                                <input type="text" class="form-control font-monospace" id="currentValueBin" value="10101010" readonly>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ç›®æ ‡å€¼:</label>
                            <div class="input-group">
                                <span class="input-group-text">Hex</span>
                                <input type="text" class="form-control" id="targetValueHex" value="55" readonly>
                                <span class="input-group-text">Bin</span>
                                <input type="text" class="form-control font-monospace" id="targetValueBin" value="01010101" readonly>
                            </div>
                        </div>

                        <div class="alert alert-secondary mb-0">
                            <h6 class="mb-2">ğŸ” ä½çº§åˆ«åˆ†æ:</h6>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="font-monospace" id="bitAnalysis">
                                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                                </span>
                            </div>
                            <small class="text-muted" id="bitAnalysisResult"></small>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’®å¡ç‰‡ -->
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">âš¡ æ“ä½œ</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button id="writeBtn" class="btn btn-primary" onclick="attemptWrite()">
                                âœï¸ å°è¯•å†™å…¥ 0x55
                            </button>
                            <button id="eraseBtn" class="btn btn-warning" onclick="erasePage()" disabled>
                                ğŸ§¹ æ“¦é™¤ Page #5
                            </button>
                            <button id="resetBtn" class="btn btn-secondary" onclick="resetExperiment()">
                                ğŸ”„ é‡ç½®å®éªŒ
                            </button>
                        </div>

                        <div id="operationLog" class="mt-3">
                            <!-- æ“ä½œæ—¥å¿— -->
                        </div>
                    </div>
                </div>

                <!-- çŠ¶æ€è¯´æ˜å¡ç‰‡ -->
                <div class="card flex-grow-1">
                    <div class="card-header">
                        <h5 class="mb-0">ğŸ“– å®éªŒè¯´æ˜</h5>
                    </div>
                    <div class="card-body">
                        <div class="experiment-steps">
                            <div class="step-item" id="step1">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <strong>å°è¯•ç›´æ¥å†™å…¥</strong>
                                    <p class="small text-muted mb-0">ç‚¹å‡»"å°è¯•å†™å…¥"çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆ</p>
                                </div>
                            </div>
                            <div class="step-item" id="step2">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <strong>è§‚å¯Ÿå¤±è´¥åŸå› </strong>
                                    <p class="small text-muted mb-0">ä½çº§åˆ«åˆ†æä¼šæ˜¾ç¤ºå“ªäº›ä½æ— æ³•è½¬æ¢</p>
                                </div>
                            </div>
                            <div class="step-item" id="step3">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <strong>æ“¦é™¤Page</strong>
                                    <p class="small text-muted mb-0">æ“¦é™¤åæ‰€æœ‰ä½å˜ä¸º1 (0xFF)</p>
                                </div>
                            </div>
                            <div class="step-item" id="step4">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <strong>å†æ¬¡å†™å…¥</strong>
                                    <p class="small text-muted mb-0">è¿™æ¬¡åº”è¯¥æˆåŠŸäº†ï¼</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æˆåŠŸåº†ç¥æ¨¡æ€æ¡† -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">ğŸ‰ æ­å–œæˆåŠŸï¼</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>âœ… ä½ æˆåŠŸå°† 0xAA æ”¹æˆäº† 0x55ï¼</h6>
                <div class="alert alert-success">
                    <p class="mb-1"><strong>æ ¸å¿ƒçŸ¥è¯†ç‚¹:</strong></p>
                    <ul class="mb-0">
                        <li>EEPROMåªèƒ½å°†1å˜æˆ0ï¼Œä¸èƒ½å°†0å˜æˆ1</li>
                        <li>å†™å…¥å‰å¿…é¡»å…ˆæ“¦é™¤ï¼ˆæ“¦é™¤å°†æ‰€æœ‰ä½è®¾ä¸º1ï¼‰</li>
                        <li>æ“¦é™¤çš„æœ€å°å•ä½æ˜¯æ•´ä¸ªPageï¼ˆ256å­—èŠ‚ï¼‰</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="resetExperiment()">
                    ğŸ”„ å†è¯•ä¸€æ¬¡
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* ç¡®ä¿ä¸»è¦å†…å®¹åŒºåŸŸå……æ»¡å¯ç”¨ç©ºé—´ï¼Œä½†ä¸å½±å“å¯¼èˆªæ å®¹å™¨ */
.page-shell {
    min-height: calc(100vh - 100px);
}

/* EEPROMç½‘æ ¼ */
.eeprom-grid {
    display: grid;
    grid-template-columns: repeat(16, 1fr);
    gap: 0;
    background: #dee2e6;
    padding: 2px;
    border-radius: 2px;
    max-width: 100%;
    overflow: hidden;
}

.grid-cell {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 5px;
    font-family: monospace;
    background: #e9ecef;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
    cursor: default;
    min-height: 14px;
}

.grid-cell.data-written {
    background: #a8dadc;
    font-weight: bold;
}

.grid-cell.target {
    background: #ff6b6b;
    font-weight: bold;
    animation: pulse 1s infinite;
}

.grid-cell.write-fail {
    background: #ffeaa7;
    animation: shake 0.5s;
}

.grid-cell.write-success {
    background: #55efc4;
    font-weight: bold;
}

.grid-cell.erased {
    background: #e9ecef;
    animation: flash 0.5s;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); box-shadow: 0 0 10px rgba(255, 107, 107, 0.5); }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

@keyframes flash {
    0%, 100% { background: #e9ecef; }
    50% { background: #ffeaa7; }
}

/* å›¾ä¾‹ */
.grid-cell-example {
    width: 20px;
    height: 20px;
    border-radius: 2px;
    margin-right: 5px;
}

/* ä½åˆ†æ */
.bit-cell {
    display: inline-block;
    width: 20px;
    height: 25px;
    line-height: 25px;
    text-align: center;
    margin: 0 2px;
    border-radius: 3px;
    font-weight: bold;
}

.bit-can-write {
    background: #d4edda;
    color: #155724;
}

.bit-cannot-write {
    background: #f8d7da;
    color: #721c24;
    animation: highlight-error 1s infinite;
}

@keyframes highlight-error {
    0%, 100% { background: #f8d7da; }
    50% { background: #f5c6cb; }
}

/* æ“ä½œæ—¥å¿— */
.log-entry {
    padding: 8px;
    margin-bottom: 5px;
    border-radius: 4px;
    font-size: 12px;
    border-left: 3px solid #007bff;
}

.log-success {
    background: #d4edda;
    border-left-color: #28a745;
}

.log-error {
    background: #f8d7da;
    border-left-color: #dc3545;
}

.log-info {
    background: #d1ecf1;
    border-left-color: #17a2b8;
}

/* å®éªŒæ­¥éª¤ */
.experiment-steps {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.step-item {
    display: flex;
    gap: 0.75rem;
    opacity: 0.5;
    transition: all 0.3s ease;
}

.step-item.active {
    opacity: 1;
}

.step-item.completed {
    opacity: 0.7;
}

.step-number {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #dee2e6;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
}

.step-item.active .step-number {
    background: #2563eb;
    color: white;
    animation: pulse 2s infinite;
}

.step-item.completed .step-number {
    background: #10b981;
    color: white;
}

.step-content {
    flex: 1;
}

/* å“åº”å¼ */
@media (max-width: 991px) {
    .page-shell {
        min-height: auto;
    }

    .eeprom-grid {
        min-height: 300px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
const PAGE_ID = 5;
const TARGET_OFFSET = 10;
const CURRENT_VALUE = 0xAA;
const TARGET_VALUE = 0x55;

let pageData = new Array(256).fill(0xFF);
let isErased = false;
let isWritten = false;

// åˆå§‹åŒ–Page
function initPage() {
    // è®¾ç½®ç›®æ ‡ä½ç½®çš„æ•°æ®
    for (let i = 0; i < 16; i++) {
        pageData[TARGET_OFFSET + i] = CURRENT_VALUE;
    }
    isErased = false;
    isWritten = false;
    updateDisplay();
    updateBitAnalysis();
    updateSteps(1);
}

// æ›´æ–°æ˜¾ç¤º
function updateDisplay() {
    const grid = document.getElementById('pageGrid');
    grid.innerHTML = '';

    for (let i = 0; i < 256; i++) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.textContent = pageData[i].toString(16).toUpperCase().padStart(2, '0');

        // åº”ç”¨æ ·å¼
        if (i >= TARGET_OFFSET && i < TARGET_OFFSET + 16) {
            cell.classList.add('data-written');
        }

        if (i === TARGET_OFFSET) {
            cell.classList.add('target');
        }

        grid.appendChild(cell);
    }

    // æ›´æ–°çŠ¶æ€
    document.getElementById('pageStatus').textContent = isErased ? 'å·²æ“¦é™¤' : 'å·²å†™å…¥æ•°æ®';
}

// æ›´æ–°ä½åˆ†æ
function updateBitAnalysis() {
    const analysis = document.getElementById('bitAnalysis');
    const result = document.getElementById('bitAnalysisResult');

    let html = '';
    let canWrite = true;

    for (let i = 7; i >= 0; i--) {
        const currentBit = (CURRENT_VALUE >> i) & 1;
        const targetBit = (TARGET_VALUE >> i) & 1;

        if (currentBit === 0 && targetBit === 1) {
            // éœ€è¦0â†’1ï¼Œæ— æ³•ç›´æ¥å†™å…¥
            html += `<span class="bit-cell bit-cannot-write">0â†’1</span>`;
            canWrite = false;
        } else if (currentBit === 1 && targetBit === 0) {
            // å¯ä»¥1â†’0
            html += `<span class="bit-cell bit-can-write">1â†’0</span>`;
        } else {
            // ç›¸åŒ
            html += `<span class="bit-cell">${currentBit}</span>`;
        }
    }

    analysis.innerHTML = html;

    if (canWrite) {
        result.innerHTML = '<span class="text-success">âœ… å¯ä»¥ç›´æ¥å†™å…¥ï¼</span>';
    } else {
        result.innerHTML = '<span class="text-danger">âŒ éœ€è¦æ“¦é™¤ï¼æœ‰ä½éœ€è¦0â†’1è½¬æ¢</span>';
    }
}

// å°è¯•å†™å…¥
function attemptWrite() {
    if (isWritten) {
        addLog('æ•°æ®å·²å†™å…¥æˆåŠŸ', 'info');
        return;
    }

    addLog('å°è¯•å†™å…¥ 0x55 åˆ°åç§»10...', 'info');

    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å†™å…¥
    const canWrite = ((CURRENT_VALUE | TARGET_VALUE) === CURRENT_VALUE);

    if (canWrite || isErased) {
        // å¯ä»¥å†™å…¥
        pageData[TARGET_OFFSET] = TARGET_VALUE;
        isWritten = true;

        // æ›´æ–°æ˜¾ç¤º
        updateDisplay();
        highlightCell(TARGET_OFFSET, 'write-success');

        addLog('âœ… å†™å…¥æˆåŠŸï¼æ•°æ®å·²æ›´æ–°', 'success');

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.getElementById('writeBtn').disabled = true;

        // æ˜¾ç¤ºæˆåŠŸæ¨¡æ€æ¡†
        setTimeout(() => {
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
        }, 500);

        updateSteps(4);
    } else {
        // æ— æ³•å†™å…¥
        highlightCell(TARGET_OFFSET, 'write-fail');

        addLog('âŒ å†™å…¥å¤±è´¥ï¼éœ€è¦0â†’1çš„ä½æ— æ³•è½¬æ¢', 'error');

        // å¯ç”¨æ“¦é™¤æŒ‰é’®
        document.getElementById('eraseBtn').disabled = false;

        updateSteps(2);
    }
}

// æ“¦é™¤Page
async function erasePage() {
    addLog('å¼€å§‹æ“¦é™¤ Page #5...', 'info');

    // æ“¦é™¤åŠ¨ç”»
    for (let i = 0; i < 256; i++) {
        pageData[i] = 0xFF;
        if (i % 16 === 0) {
            updateDisplay();
            await sleep(20);
        }
    }

    isErased = true;
    updateDisplay();

    // é«˜äº®æ“¦é™¤æ•ˆæœ
    for (let i = TARGET_OFFSET; i < TARGET_OFFSET + 16; i++) {
        const cells = document.querySelectorAll('.grid-cell');
        if (cells[i]) {
            cells[i].classList.add('erased');
        }
    }

    addLog('âœ… Pageæ“¦é™¤å®Œæˆï¼æ‰€æœ‰ä½å·²è®¾ä¸º1 (0xFF)', 'success');

    // ç¦ç”¨æ“¦é™¤æŒ‰é’®ï¼Œå¯ç”¨å†™å…¥æŒ‰é’®
    document.getElementById('eraseBtn').disabled = true;
    document.getElementById('writeBtn').disabled = false;

    // æ›´æ–°ä½åˆ†æ
    updateBitAnalysis();

    updateSteps(3);
}

// é«˜äº®å•å…ƒæ ¼
function highlightCell(index, className) {
    const cells = document.querySelectorAll('.grid-cell');
    if (cells[index]) {
        cells[index].classList.add(className);
    }
}

// æ·»åŠ æ—¥å¿—
function addLog(message, type = 'info') {
    const log = document.getElementById('operationLog');
    const entry = document.createElement('div');
    entry.className = `log-entry log-${type}`;
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    log.insertBefore(entry, log.firstChild);

    // é™åˆ¶æ—¥å¿—æ•°é‡
    while (log.children.length > 5) {
        log.removeChild(log.lastChild);
    }
}

// æ›´æ–°æ­¥éª¤
function updateSteps(currentStep) {
    for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        step.classList.remove('active', 'completed');

        if (i < currentStep) {
            step.classList.add('completed');
        } else if (i === currentStep) {
            step.classList.add('active');
        }
    }
}

// é‡ç½®å®éªŒ
function resetExperiment() {
    addLog('é‡ç½®å®éªŒ...', 'info');

    // é‡ç½®æ•°æ®
    initPage();

    // é‡ç½®æŒ‰é’®çŠ¶æ€
    document.getElementById('writeBtn').disabled = false;
    document.getElementById('eraseBtn').disabled = true;

    // æ¸…ç©ºæ—¥å¿—
    document.getElementById('operationLog').innerHTML = '';

    updateSteps(1);
}

// è¾…åŠ©å‡½æ•°
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// é¡µé¢åŠ è½½åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initPage();
});
</script>
{% endblock %}
